---
phase: 04-http-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cesar/api/server.py
  - cesar/api/__init__.py
  - pyproject.toml
  - tests/test_server.py
autonomous: true

must_haves:
  truths:
    - "GET /health returns server health with worker status"
    - "OpenAPI docs available at /docs"
    - "Worker starts automatically with server"
    - "Server shuts down gracefully"
  artifacts:
    - path: "cesar/api/server.py"
      provides: "FastAPI app with lifespan and health endpoint"
      min_lines: 50
    - path: "tests/test_server.py"
      provides: "Server and health endpoint tests"
      min_lines: 30
  key_links:
    - from: "cesar/api/server.py"
      to: "cesar/api/worker.py"
      via: "lifespan context manager"
      pattern: "BackgroundWorker"
    - from: "cesar/api/server.py"
      to: "cesar/api/repository.py"
      via: "lifespan context manager"
      pattern: "JobRepository"
---

<objective>
Create FastAPI server with lifespan events for worker lifecycle and health endpoint.

Purpose: Establish the HTTP foundation - the server that hosts all API endpoints, manages worker lifecycle, and provides OpenAPI documentation.

Output:
- FastAPI application with lifespan context manager
- Health endpoint at GET /health
- Worker starts/stops with server
- OpenAPI docs at /docs
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-http-api/04-RESEARCH.md
@cesar/api/worker.py
@cesar/api/repository.py
@cesar/api/__init__.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add FastAPI dependencies to pyproject.toml</name>
  <files>pyproject.toml</files>
  <action>
Add these dependencies to pyproject.toml:
- fastapi>=0.109.0
- uvicorn>=0.25.0
- python-multipart>=0.0.6
- httpx>=0.26.0

Add after the existing dependencies in the dependencies array.
  </action>
  <verify>Run `pip install -e .` successfully installs FastAPI dependencies</verify>
  <done>pyproject.toml includes fastapi, uvicorn, python-multipart, httpx as dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create FastAPI server with lifespan and health endpoint</name>
  <files>cesar/api/server.py, cesar/api/__init__.py</files>
  <action>
Create cesar/api/server.py with:

1. Lifespan context manager (async context manager pattern):
   - Initialize JobRepository with database path (~/.local/share/cesar/jobs.db)
   - Call await repo.connect()
   - Create BackgroundWorker with repository
   - Start worker with asyncio.create_task(worker.run())
   - Store repo, worker, worker_task in app.state
   - On shutdown: await worker.shutdown(), await worker_task, await repo.close()

2. FastAPI app instance:
   - title: "Cesar Transcription API"
   - description: "Offline audio transcription with async job queue"
   - version: "2.0.0"
   - lifespan: the lifespan context manager

3. Health endpoint:
   - GET /health
   - Returns: {"status": "healthy", "worker": "running"|"stopped"}
   - Worker status based on: worker_task.done() and worker.is_processing

4. Update cesar/api/__init__.py to export the app.

Use the pattern from 04-RESEARCH.md for lifespan events.
Do NOT use @app.on_event decorators (deprecated).
  </action>
  <verify>
- `python -c "from cesar.api.server import app; print(app.title)"` outputs "Cesar Transcription API"
- `python -c "from cesar.api import app; print(type(app))"` shows FastAPI
  </verify>
  <done>
- cesar/api/server.py exists with lifespan context manager, FastAPI app, and /health endpoint
- app exported from cesar/api/__init__.py
  </done>
</task>

<task type="auto">
  <name>Task 3: Create server and health endpoint tests</name>
  <files>tests/test_server.py</files>
  <action>
Create tests/test_server.py using FastAPI TestClient and unittest:

1. Import TestClient from fastapi.testclient
2. Use IsolatedAsyncioTestCase pattern (consistent with existing tests)

Test cases:
- test_health_returns_200: GET /health returns 200
- test_health_response_format: Response has "status" and "worker" keys
- test_health_status_is_healthy: status == "healthy"
- test_health_worker_status: worker is "running" or "stopped"
- test_openapi_docs_available: GET /docs returns 200
- test_openapi_json_available: GET /openapi.json returns 200

Note: TestClient handles lifespan automatically for tests.
Mock the worker and repository in tests to avoid actual database/transcription.
  </action>
  <verify>Run `python -m pytest tests/test_server.py -v` - all tests pass</verify>
  <done>tests/test_server.py has 6+ tests covering health endpoint and OpenAPI availability</done>
</task>

</tasks>

<verification>
1. All tests pass: `python -m pytest tests/ -v`
2. Import works: `python -c "from cesar.api.server import app"`
3. Health endpoint documented: Start server briefly with `uvicorn cesar.api.server:app --host 127.0.0.1 --port 8888 &` then `curl http://127.0.0.1:8888/health` returns JSON with status
</verification>

<success_criteria>
- FastAPI app created with proper lifespan
- Health endpoint returns worker status
- OpenAPI docs available at /docs
- All tests pass
- Dependencies added to pyproject.toml
</success_criteria>

<output>
After completion, create `.planning/phases/04-http-api/04-01-SUMMARY.md`
</output>
