---
phase: 04-http-api
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - cesar/api/server.py
  - tests/test_server.py
autonomous: true

must_haves:
  truths:
    - "GET /jobs/{id} returns job details when job exists"
    - "GET /jobs/{id} returns 404 when job not found"
    - "GET /jobs returns list of all jobs"
    - "GET /jobs?status=queued filters by status"
  artifacts:
    - path: "cesar/api/server.py"
      provides: "Job GET endpoints"
      contains: "@app.get(\"/jobs\""
    - path: "tests/test_server.py"
      provides: "Tests for job GET endpoints"
      min_lines: 80
  key_links:
    - from: "cesar/api/server.py"
      to: "cesar/api/repository.py"
      via: "app.state.repo"
      pattern: "app\\.state\\.repo\\.(get|list_all)"
---

<objective>
Add job retrieval endpoints: GET /jobs/{id} and GET /jobs with optional status filter.

Purpose: Enable clients to check job status, retrieve results when complete, and list all jobs.

Output:
- GET /jobs/{id} endpoint returning job details or 404
- GET /jobs endpoint with optional ?status= filter
- Comprehensive endpoint tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-http-api/04-01-SUMMARY.md
@cesar/api/server.py
@cesar/api/models.py
@cesar/api/repository.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GET /jobs/{id} endpoint</name>
  <files>cesar/api/server.py</files>
  <action>
Add to cesar/api/server.py:

1. Import Path from fastapi (as PathParam to avoid conflict with pathlib.Path)
2. Import List and Optional from typing
3. Add Job to imports from cesar.api.models

4. Create GET /jobs/{job_id} endpoint:
   - Path: /jobs/{job_id}
   - Response model: Job
   - Docstring: "Get job status and results by ID."
   - Implementation:
     - job = await app.state.repo.get(job_id)
     - if not job: raise HTTPException(status_code=404, detail=f"Job not found: {job_id}")
     - return job

Note: FastAPI Path parameter should have description: "Job UUID"
  </action>
  <verify>`python -c "from cesar.api.server import app; print([r.path for r in app.routes if '/jobs' in r.path])"` shows /jobs/{job_id}</verify>
  <done>GET /jobs/{job_id} endpoint returns job or 404</done>
</task>

<task type="auto">
  <name>Task 2: Add GET /jobs endpoint with status filter</name>
  <files>cesar/api/server.py</files>
  <action>
Add to cesar/api/server.py:

1. Import JobStatus from cesar.api.models

2. Create GET /jobs endpoint:
   - Path: /jobs
   - Response model: List[Job]
   - Query parameter: status: Optional[str] = None
   - Docstring: "List all jobs, optionally filtered by status."
   - Implementation:
     - jobs = await app.state.repo.list_all()
     - if status:
       - Validate status is valid JobStatus value
       - Filter jobs where job.status.value == status
       - If invalid status, raise HTTPException(400, detail=f"Invalid status: {status}. Valid: queued, processing, completed, error")
     - return jobs
  </action>
  <verify>`python -c "from cesar.api.server import app; print([r.path for r in app.routes])"` shows /jobs</verify>
  <done>GET /jobs endpoint returns job list with optional status filter</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for job endpoints</name>
  <files>tests/test_server.py</files>
  <action>
Add test cases to tests/test_server.py:

For GET /jobs/{id}:
- test_get_job_not_found: Returns 404 for non-existent job ID
- test_get_job_success: Create job via repo, GET returns it
- test_get_job_response_format: Response has all Job fields (id, status, audio_path, etc.)

For GET /jobs:
- test_list_jobs_empty: Empty database returns []
- test_list_jobs_multiple: Returns all jobs
- test_list_jobs_filter_queued: ?status=queued filters correctly
- test_list_jobs_filter_invalid: Invalid status returns 400

Test approach:
- Use TestClient with mock repository
- Or use in-memory database for integration tests
- Inject test jobs into repository before testing GET endpoints
  </action>
  <verify>Run `python -m pytest tests/test_server.py -v` - all tests pass</verify>
  <done>7+ new tests covering GET /jobs and GET /jobs/{id} endpoints</done>
</task>

</tasks>

<verification>
1. All tests pass: `python -m pytest tests/test_server.py -v`
2. Endpoints appear in routes: `python -c "from cesar.api.server import app; [print(r.path) for r in app.routes]"`
3. OpenAPI schema includes both endpoints: Check /openapi.json contains /jobs and /jobs/{job_id}
</verification>

<success_criteria>
- GET /jobs/{id} returns job or 404
- GET /jobs returns list with optional filtering
- Invalid status returns 400
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-http-api/04-02-SUMMARY.md`
</output>
