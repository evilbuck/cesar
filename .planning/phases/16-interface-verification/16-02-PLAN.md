---
phase: 16-interface-verification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/test_server.py
autonomous: true

must_haves:
  truths:
    - "API diarize parameter creates job with diarization enabled"
    - "POST /transcribe with diarize=true returns job with correct fields"
    - "API interface unchanged after WhisperX migration"
  artifacts:
    - path: "tests/test_server.py"
      provides: "E2E diarization API test class"
      contains: "TestTranscribeEndpointDiarizationE2E"
  key_links:
    - from: "tests/test_server.py"
      to: "cesar.api.server"
      via: "TestClient.post()"
      pattern: 'post.*transcribe.*diarize'
---

<objective>
Create E2E API test that validates POST /transcribe with diarize=true works unchanged after WhisperX migration.

Purpose: Verify API interface preservation (WX-07) and E2E API behavior (WX-12). This proves the API endpoint works correctly with the new WhisperX backend.
Output: New test class in test_server.py with E2E diarization tests using real audio file upload.
</objective>

<execution_context>
@/home/buckleyrobinson/.claude/get-shit-done/workflows/execute-plan.md
@/home/buckleyrobinson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-interface-verification/16-CONTEXT.md
@.planning/phases/16-interface-verification/16-RESEARCH.md

# Source files
@tests/test_server.py
@tests/test_whisperx_wrapper.py
@cesar/api/server.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create E2E API diarization test class</name>
  <files>tests/test_server.py</files>
  <action>
Add a new test class `TestTranscribeEndpointDiarizationE2E` to tests/test_server.py (before the `if __name__ == "__main__":` block) with the following structure:

1. **Test class setup:**
   - Add shutil and Path imports at top if not present
   - Create setUp() that:
     - Sets up mock repository and worker (same pattern as TestHealthEndpoint)
     - Patches cesar.api.server.JobRepository and cesar.api.server.BackgroundWorker
     - Creates TestClient with the app
     - Sets path to real audio file at `assets/testing speech audio file.m4a`

   - Create tearDown() that stops patches and closes client

2. **Create test_api_transcribe_diarize_parameter_creates_job():**
   - Open real audio file in binary mode
   - POST to "/transcribe" with:
     - files={"audio": ("test.m4a", audio_file, "audio/mp4")}
     - data={"model_size": "base", "diarize": "true"}
   - Assert response.status_code == 201
   - Assert response JSON contains "job_id" key
   - Assert response JSON "diarize" field is True
   - Verify repository.create was called with job that has diarize=True

3. **Create test_api_transcribe_diarize_false_parameter():**
   - Same upload pattern but with diarize="false"
   - Assert job created with diarize=False
   - Verify repository.create called with job.diarize=False

4. **Create test_api_transcribe_diarize_default_true():**
   - POST without diarize parameter (test default behavior)
   - Assert job created with diarize=True (default)
   - This verifies the default behavior matches CLI (diarize=True)

Note: The API tests focus on job creation (interface). Worker execution is tested separately.
The mocked repository.create should use side_effect=lambda job: job to return the created job.
  </action>
  <verify>
Run the new tests:
```bash
cd /home/buckleyrobinson/projects/cesar && python -m pytest tests/test_server.py::TestTranscribeEndpointDiarizationE2E -v
```
All 3 tests should pass.
  </verify>
  <done>
- TestTranscribeEndpointDiarizationE2E class exists in test_server.py
- test_api_transcribe_diarize_parameter_creates_job passes
- test_api_transcribe_diarize_false_parameter passes
- test_api_transcribe_diarize_default_true passes
- Tests use real audio file for upload
- Tests verify API interface unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Add API response schema validation tests</name>
  <files>tests/test_server.py</files>
  <action>
Add additional test methods to TestTranscribeEndpointDiarizationE2E class:

1. **test_api_transcribe_response_schema():**
   - POST with diarize=true
   - Verify response JSON has all required fields:
     - job_id (string, UUID format)
     - status (string)
     - diarize (boolean, true)
     - model_size (string)
     - created_at (string, ISO format)
   - This validates the response contract is unchanged

2. **test_api_job_status_includes_diarize_field():**
   - Create job via POST /transcribe
   - Mock repository.get to return the job
   - GET /jobs/{job_id}
   - Verify response includes diarize field matching creation request
   - This tests the full job lifecycle interface

3. **test_api_transcribe_with_speaker_options():**
   - POST with diarize=true, min_speakers=2, max_speakers=4
   - Verify job created with speaker options preserved
   - Verify response contains the speaker range options

These tests ensure the API response contract is preserved after migration.
  </action>
  <verify>
Run all diarization E2E API tests:
```bash
cd /home/buckleyrobinson/projects/cesar && python -m pytest tests/test_server.py::TestTranscribeEndpointDiarizationE2E -v
```
All tests (now 6 total in class) should pass.
  </verify>
  <done>
- test_api_transcribe_response_schema validates response contract
- test_api_job_status_includes_diarize_field validates job retrieval
- test_api_transcribe_with_speaker_options validates speaker config
- All 6 TestTranscribeEndpointDiarizationE2E tests pass
- Requirements WX-07 and WX-12 are fully covered
  </done>
</task>

</tasks>

<verification>
Run API test suite to ensure no regressions:
```bash
cd /home/buckleyrobinson/projects/cesar && python -m pytest tests/test_server.py -v
```

Expected: All tests pass including new TestTranscribeEndpointDiarizationE2E tests.
</verification>

<success_criteria>
1. TestTranscribeEndpointDiarizationE2E class added to test_server.py with 6 test methods
2. All tests use real audio file from assets/ for upload
3. Tests mock repository and worker (not whisperx - API doesn't execute pipeline)
4. E2E test verifies API diarize parameter creates correct job
5. E2E test verifies response schema unchanged
6. All existing test_server.py tests still pass
7. Requirements WX-07 (API diarize unchanged) and WX-12 (E2E API test) verified
</success_criteria>

<output>
After completion, create `.planning/phases/16-interface-verification/16-02-SUMMARY.md`
</output>
