---
phase: 16-interface-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/test_cli.py
autonomous: true

must_haves:
  truths:
    - "CLI --diarize flag produces speaker-labeled Markdown output"
    - "CLI with real audio file (mocked whisperx) completes successfully"
    - "Output file contains speaker headers and timestamps"
  artifacts:
    - path: "tests/test_cli.py"
      provides: "E2E diarization CLI test class"
      contains: "TestDiarizationE2E"
  key_links:
    - from: "tests/test_cli.py"
      to: "cesar.cli"
      via: "CliRunner.invoke()"
      pattern: "runner\\.invoke.*--diarize"
---

<objective>
Create E2E CLI test that validates cesar transcribe --diarize works unchanged after WhisperX migration.

Purpose: Verify CLI interface preservation (WX-06) and E2E CLI behavior (WX-11). This proves the user-facing CLI works correctly with the new WhisperX backend.
Output: New test class in test_cli.py with E2E diarization tests using real audio file and mocked whisperx library.
</objective>

<execution_context>
@/home/buckleyrobinson/.claude/get-shit-done/workflows/execute-plan.md
@/home/buckleyrobinson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-interface-verification/16-CONTEXT.md
@.planning/phases/16-interface-verification/16-RESEARCH.md

# Source files
@tests/test_cli.py
@tests/test_whisperx_wrapper.py
@cesar/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create E2E CLI diarization test class</name>
  <files>tests/test_cli.py</files>
  <action>
Add a new test class `TestDiarizationE2E` to tests/test_cli.py (before the `if __name__ == "__main__":` block) with the following structure:

1. **Test class setup:**
   - Import shutil at top of file (add to existing imports if not present)
   - Create setUp() that initializes CliRunner and sets path to real audio file at `assets/testing speech audio file.m4a`
   - No tearDown needed (CliRunner.isolated_filesystem() handles cleanup)

2. **Create _create_mock_whisperx() helper method:**
   - Use pattern from test_whisperx_wrapper.py lines 267-312
   - Mock load_audio returning numpy-like array with __len__ = 178176 (11.136s at 16kHz)
   - Mock load_model returning model with transcribe() returning 2 segments
   - Mock load_align_model returning (model, metadata) tuple
   - Mock align returning segments with speaker labels
   - Mock DiarizationPipeline returning callable pipeline
   - Mock assign_word_speakers returning segments with SPEAKER_00 and SPEAKER_01

3. **Create test_cli_diarize_produces_markdown_with_speakers():**
   - Use patch.dict('sys.modules', {'whisperx': mock_whisperx}) pattern
   - Use self.runner.isolated_filesystem() for file isolation
   - Copy real audio file into isolated filesystem using shutil.copy
   - Invoke cli with ['transcribe', str(audio_path), '-o', 'output.md', '--diarize', '--quiet']
   - Assert exit_code == 0
   - Assert output file exists with .md extension
   - Assert file content contains '### Speaker' (speaker headers)
   - Assert file content contains '[00:' (timestamp format)

4. **Create test_cli_diarize_without_quiet_shows_progress():**
   - Same mocking pattern
   - Invoke without --quiet flag
   - Verify exit_code == 0
   - Verify output contains progress indicators (transcription phase messages)

Note: Mock at whisperx library boundary (not WhisperXPipeline) to test the full integration code path.
  </action>
  <verify>
Run the new tests:
```bash
cd /home/buckleyrobinson/projects/cesar && python -m pytest tests/test_cli.py::TestDiarizationE2E -v
```
Both tests should pass.
  </verify>
  <done>
- TestDiarizationE2E class exists in test_cli.py
- test_cli_diarize_produces_markdown_with_speakers passes
- test_cli_diarize_without_quiet_shows_progress passes
- Tests use real audio file with mocked whisperx library
- Tests verify Markdown output format with speaker labels and timestamps
  </done>
</task>

<task type="auto">
  <name>Task 2: Add fallback and edge case tests</name>
  <files>tests/test_cli.py</files>
  <action>
Add additional test methods to TestDiarizationE2E class:

1. **test_cli_diarize_fallback_on_auth_error():**
   - Mock whisperx.DiarizationPipeline to raise exception simulating AuthenticationError
   - Verify CLI completes with exit_code 0 (fallback to plain transcription)
   - Verify output file exists (plain text fallback worked)
   - Verify warning message in output about diarization failure

2. **test_cli_no_diarize_produces_plain_text():**
   - Use --no-diarize flag instead of --diarize
   - Mock AudioTranscriber (not whisperx) since no diarization needed
   - Verify output file has .txt extension (corrected from any user-provided extension)
   - Verify file content does NOT contain '### Speaker' headers

3. **test_cli_diarize_with_model_size_option():**
   - Test with `--model small` option
   - Verify whisperx.load_model was called (can check via mock assertion)
   - Verify exit_code == 0

These tests ensure the CLI handles edge cases correctly after the WhisperX migration.
  </action>
  <verify>
Run all diarization E2E tests:
```bash
cd /home/buckleyrobinson/projects/cesar && python -m pytest tests/test_cli.py::TestDiarizationE2E -v
```
All tests (now 5 total in class) should pass.
  </verify>
  <done>
- test_cli_diarize_fallback_on_auth_error verifies graceful fallback
- test_cli_no_diarize_produces_plain_text verifies --no-diarize works
- test_cli_diarize_with_model_size_option verifies model option passes through
- All 5 TestDiarizationE2E tests pass
- Requirements WX-06 and WX-11 are fully covered
  </done>
</task>

</tasks>

<verification>
Run CLI test suite to ensure no regressions:
```bash
cd /home/buckleyrobinson/projects/cesar && python -m pytest tests/test_cli.py -v
```

Expected: All tests pass including new TestDiarizationE2E tests.
</verification>

<success_criteria>
1. TestDiarizationE2E class added to test_cli.py with 5 test methods
2. All tests use real audio file from assets/
3. Tests mock at whisperx library boundary (not internal classes)
4. E2E test verifies CLI --diarize produces Markdown with speaker labels
5. E2E test verifies fallback works when diarization fails
6. All existing test_cli.py tests still pass
7. Requirements WX-06 (CLI --diarize unchanged) and WX-11 (E2E CLI test) verified
</success_criteria>

<output>
After completion, create `.planning/phases/16-interface-verification/16-01-SUMMARY.md`
</output>
