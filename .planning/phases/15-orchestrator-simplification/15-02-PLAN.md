---
phase: 15-orchestrator-simplification
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - cesar/cli.py
  - cesar/api/worker.py
autonomous: true

must_haves:
  truths:
    - "CLI --diarize flag uses WhisperXPipeline via orchestrator"
    - "API worker uses WhisperXPipeline via orchestrator when diarize=True"
    - "Error messages do not expose 'WhisperX' to users"
    - "Partial success messaging: 'Transcription succeeded, diarization failed' before fallback"
    - "CLI and worker pass AudioTranscriber to orchestrator for fallback"
  artifacts:
    - path: "cesar/cli.py"
      provides: "CLI with WhisperXPipeline integration and fallback support"
      contains: "WhisperXPipeline"
    - path: "cesar/api/worker.py"
      provides: "Worker with WhisperXPipeline integration and fallback support"
      contains: "WhisperXPipeline"
  key_links:
    - from: "cesar/cli.py"
      to: "cesar/whisperx_wrapper.py"
      via: "WhisperXPipeline import"
      pattern: "from cesar.whisperx_wrapper import WhisperXPipeline"
    - from: "cesar/api/worker.py"
      to: "cesar/whisperx_wrapper.py"
      via: "WhisperXPipeline import"
      pattern: "from cesar.whisperx_wrapper import WhisperXPipeline"
    - from: "cesar/cli.py"
      to: "cesar/orchestrator.py"
      via: "TranscriptionOrchestrator with both pipeline and transcriber"
      pattern: "TranscriptionOrchestrator.*pipeline.*transcriber"
---

<objective>
Update CLI and API worker to use simplified orchestrator with WhisperXPipeline

Purpose: Connect user-facing interfaces (CLI and API) to the new WhisperXPipeline-based orchestrator. Pass both pipeline and transcriber to enable fallback when diarization fails. Remove references to SpeakerDiarizer and ensure error messages remain user-friendly.

Output: CLI and worker creating WhisperXPipeline and AudioTranscriber, passing both to orchestrator for fallback support, clear partial-success messaging
</objective>

<execution_context>
@/home/buckleyrobinson/.claude/get-shit-done/workflows/execute-plan.md
@/home/buckleyrobinson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-orchestrator-simplification/15-CONTEXT.md
@.planning/phases/15-orchestrator-simplification/15-01-SUMMARY.md
@cesar/cli.py
@cesar/api/worker.py
@cesar/orchestrator.py
@cesar/whisperx_wrapper.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CLI to use WhisperXPipeline with fallback</name>
  <files>cesar/cli.py</files>
  <action>
Update the transcribe command to use WhisperXPipeline instead of SpeakerDiarizer, while passing AudioTranscriber for fallback capability.

Import changes:
- Remove: `from cesar.diarization import SpeakerDiarizer, DiarizationError`
- Add: `from cesar.whisperx_wrapper import WhisperXPipeline`
- Add: `from cesar.diarization import DiarizationError, AuthenticationError`

In transcribe command (around line 446-476):
1. Replace diarizer creation with pipeline creation:
   ```python
   # OLD:
   diarizer = SpeakerDiarizer(hf_token=hf_token)

   # NEW:
   pipeline = WhisperXPipeline(
       model_name=model,  # Pass through the Whisper model size
       hf_token=hf_token
   )
   ```

2. Update orchestrator creation to pass BOTH pipeline and transcriber:
   ```python
   # OLD:
   orchestrator = TranscriptionOrchestrator(
       transcriber=transcriber,
       diarizer=diarizer
   )

   # NEW:
   orchestrator = TranscriptionOrchestrator(
       pipeline=pipeline,
       transcriber=transcriber  # Keep for fallback when diarization fails
   )
   ```

3. Keep the progress callback and result handling the same (orchestrator interface unchanged)

4. Update error handling to catch AuthenticationError specifically:
   - AuthenticationError: Show helpful message about HF token
   - DiarizationError: The orchestrator handles fallback internally, but CLI should log the partial success message if result shows diarization_succeeded=False

5. For non-diarization path (diarize=False):
   - Keep using AudioTranscriber directly with transcribe_file()
   - Do NOT create pipeline when diarize=False

6. Remove the "Note: Diarization enabled but no HuggingFace token found" warning path
   - Let WhisperXPipeline handle token resolution (it checks env and cache)
   - AuthenticationError will surface if token truly missing
  </action>
  <verify>
```bash
# CLI module imports cleanly
python -c "from cesar.cli import cli; print('CLI imports OK')"

# Verify WhisperXPipeline imported
grep -q "from cesar.whisperx_wrapper import WhisperXPipeline" cesar/cli.py && echo "WhisperXPipeline imported"

# Verify SpeakerDiarizer NOT imported
! grep -q "SpeakerDiarizer" cesar/cli.py && echo "SpeakerDiarizer removed"

# Verify orchestrator created with both pipeline and transcriber parameters
grep -q "TranscriptionOrchestrator(" cesar/cli.py && grep -q "pipeline=" cesar/cli.py && grep -q "transcriber=" cesar/cli.py && echo "Orchestrator uses pipeline and transcriber"
```
  </verify>
  <done>CLI creates WhisperXPipeline and passes both pipeline and transcriber to orchestrator for fallback, SpeakerDiarizer removed</done>
</task>

<task type="auto">
  <name>Task 2: Update API worker to use WhisperXPipeline with fallback</name>
  <files>cesar/api/worker.py</files>
  <action>
Update the worker's transcription logic to use WhisperXPipeline while keeping AudioTranscriber for fallback.

Import changes:
- Remove: `from cesar.diarization import SpeakerDiarizer, DiarizationError, AuthenticationError`
- Add: `from cesar.whisperx_wrapper import WhisperXPipeline`
- Add: `from cesar.diarization import DiarizationError, AuthenticationError`

In _process_transcription method (around line 402-460):
1. Replace diarizer creation with pipeline creation:
   ```python
   # OLD:
   diarizer = SpeakerDiarizer(hf_token=hf_token)
   orchestrator = TranscriptionOrchestrator(
       transcriber=transcriber,
       diarizer=diarizer
   )

   # NEW:
   pipeline = WhisperXPipeline(
       model_name=job.model or "base",  # Pass model from job
       hf_token=hf_token
   )
   orchestrator = TranscriptionOrchestrator(
       pipeline=pipeline,
       transcriber=transcriber  # Keep for fallback when diarization fails
   )
   ```

2. Error handling updates:
   - AuthenticationError: Return with diarization_error_code="hf_token_invalid"
   - DiarizationError: The orchestrator handles fallback internally now
   - Check result.diarization_succeeded - if False, set diarization_error_code="diarization_failed"
   - Keep the same response structure (diarization_succeeded, diarization_error, etc.)

3. Non-diarization path:
   - When diarize=False, continue using AudioTranscriber.transcribe_file() directly
   - Do NOT create WhisperXPipeline when diarize=False

4. Remove the hf_token_required early return path (let pipeline handle missing token):
   - If no token and diarization requested, let it fail with AuthenticationError
   - This gives clearer error messaging
  </action>
  <verify>
```bash
# Worker module imports cleanly
python -c "from cesar.api.worker import TranscriptionWorker; print('Worker imports OK')"

# Verify WhisperXPipeline imported
grep -q "from cesar.whisperx_wrapper import WhisperXPipeline" cesar/api/worker.py && echo "WhisperXPipeline imported"

# Verify SpeakerDiarizer NOT imported
! grep -q "SpeakerDiarizer" cesar/api/worker.py && echo "SpeakerDiarizer removed"

# Verify orchestrator uses both pipeline and transcriber
grep -q "pipeline=" cesar/api/worker.py && grep -q "transcriber=" cesar/api/worker.py && echo "Worker passes both to orchestrator"
```
  </verify>
  <done>Worker creates WhisperXPipeline and passes both pipeline and transcriber to orchestrator for fallback, SpeakerDiarizer removed</done>
</task>

</tasks>

<verification>
```bash
# All modules import without errors
python -c "
from cesar.cli import cli
from cesar.api.worker import TranscriptionWorker
from cesar.orchestrator import TranscriptionOrchestrator
print('All modules import OK')
"

# No references to SpeakerDiarizer in CLI or worker
! grep -q "SpeakerDiarizer" cesar/cli.py && echo "CLI clean of SpeakerDiarizer"
! grep -q "SpeakerDiarizer" cesar/api/worker.py && echo "Worker clean of SpeakerDiarizer"

# WhisperXPipeline used in both
grep -q "WhisperXPipeline" cesar/cli.py && echo "CLI uses WhisperXPipeline"
grep -q "WhisperXPipeline" cesar/api/worker.py && echo "Worker uses WhisperXPipeline"

# Error exceptions still imported from diarization module
grep -q "from cesar.diarization import" cesar/cli.py && echo "CLI imports exceptions"
grep -q "from cesar.diarization import" cesar/api/worker.py && echo "Worker imports exceptions"

# Both pass transcriber for fallback
grep -q "transcriber=" cesar/cli.py && echo "CLI passes transcriber for fallback"
grep -q "transcriber=" cesar/api/worker.py && echo "Worker passes transcriber for fallback"
```
</verification>

<success_criteria>
- CLI transcribe command uses WhisperXPipeline when --diarize enabled
- API worker uses WhisperXPipeline when diarize=True in job
- Both CLI and worker pass AudioTranscriber to orchestrator for fallback capability
- SpeakerDiarizer no longer referenced in CLI or worker
- Error handling preserves user-friendly messages (no "WhisperX" exposed)
- Both CLI and worker modules import without errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-orchestrator-simplification/15-02-SUMMARY.md`
</output>
