---
phase: 15-orchestrator-simplification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cesar/orchestrator.py
  - cesar/diarization.py
  - cesar/timestamp_aligner.py
  - cesar/transcriber.py
  - cesar/transcript_formatter.py
autonomous: true

must_haves:
  truths:
    - "timestamp_aligner.py is deleted from codebase"
    - "orchestrator.py uses WhisperXPipeline instead of SpeakerDiarizer + timestamp alignment"
    - "DiarizationError and AuthenticationError exceptions remain importable from cesar.diarization"
    - "Fallback to plain transcription works when diarization fails"
  artifacts:
    - path: "cesar/orchestrator.py"
      provides: "Simplified orchestrator using WhisperXPipeline"
      contains: "WhisperXPipeline"
    - path: "cesar/diarization.py"
      provides: "Exception classes only (SpeakerDiarizer deleted)"
      exports: ["DiarizationError", "AuthenticationError"]
  key_links:
    - from: "cesar/orchestrator.py"
      to: "cesar/whisperx_wrapper.py"
      via: "WhisperXPipeline import"
      pattern: "from cesar.whisperx_wrapper import WhisperXPipeline"
    - from: "cesar/orchestrator.py"
      to: "cesar/diarization.py"
      via: "exception import"
      pattern: "from cesar.diarization import DiarizationError"
---

<objective>
Simplify the transcription orchestrator to use WhisperX unified pipeline

Purpose: Replace multi-component pipeline (transcriber + diarizer + timestamp_aligner) with WhisperX which handles transcription, alignment, and diarization internally. Delete obsolete timestamp_aligner.py module.

Output: Simplified orchestrator.py using WhisperXPipeline, diarization.py with only exception classes, timestamp_aligner.py deleted
</objective>

<execution_context>
@/home/buckleyrobinson/.claude/get-shit-done/workflows/execute-plan.md
@/home/buckleyrobinson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-orchestrator-simplification/15-CONTEXT.md
@.planning/phases/15-orchestrator-simplification/15-RESEARCH.md
@cesar/orchestrator.py
@cesar/whisperx_wrapper.py
@cesar/diarization.py
@cesar/timestamp_aligner.py
@cesar/transcript_formatter.py
@cesar/transcriber.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Slim down diarization.py to exception classes only</name>
  <files>cesar/diarization.py</files>
  <action>
Keep only the exception class definitions (DiarizationError, AuthenticationError). Delete the SpeakerDiarizer class entirely - WhisperXPipeline replaces it.

Also keep SpeakerSegment and DiarizationResult dataclasses for backward compatibility (they may still be useful for type hints or testing).

The module should contain:
1. DiarizationError exception
2. AuthenticationError exception (subclass of DiarizationError)
3. SpeakerSegment dataclass (optional - for compatibility)
4. DiarizationResult dataclass (optional - for compatibility)

Delete: SpeakerDiarizer class and all its methods (~100 lines).
  </action>
  <verify>
```bash
python -c "from cesar.diarization import DiarizationError, AuthenticationError; print('Exceptions importable')"
python -c "from cesar.diarization import SpeakerDiarizer" 2>&1 | grep -q "cannot import" && echo "SpeakerDiarizer correctly removed"
```
  </verify>
  <done>DiarizationError and AuthenticationError importable, SpeakerDiarizer class deleted</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite orchestrator.py to use WhisperXPipeline</name>
  <files>cesar/orchestrator.py</files>
  <action>
Rewrite TranscriptionOrchestrator to use WhisperXPipeline instead of separate transcriber + diarizer + timestamp_aligner.

Constructor changes:
- Remove: transcriber parameter (AudioTranscriber)
- Remove: diarizer parameter (SpeakerDiarizer)
- Add: pipeline parameter (WhisperXPipeline, optional)
- Keep: formatter parameter (MarkdownTranscriptFormatter, optional)

orchestrate() method changes:
1. When diarization enabled AND pipeline provided:
   - Call pipeline.transcribe_and_diarize() which returns (segments, speaker_count, duration)
   - Segments are WhisperXSegment which duck-types with AlignedSegment
   - Pass segments directly to formatter (no align_timestamps call needed)

2. When diarization disabled OR pipeline not provided:
   - Need fallback transcription-only path
   - For now, raise a NotImplementedError with message "Transcription-only mode requires AudioTranscriber"
   - This will be addressed when CLI/worker integration creates the pipeline

3. Error handling:
   - Catch DiarizationError from pipeline, log explicit partial success message:
     "Transcription succeeded, diarization failed: {reason}. Falling back to plain transcript."
   - Let AuthenticationError propagate (user must fix HF token)
   - Wrap unknown exceptions in DiarizationError with `raise ... from e`

4. Progress callback:
   - Pass progress_callback to pipeline.transcribe_and_diarize()
   - Scale appropriately (0-90% for pipeline, 90-100% for formatting)

Remove imports:
- from cesar.timestamp_aligner import align_timestamps, TranscriptionSegment, AlignedSegment
- SpeakerDiarizer from diarization import

Add imports:
- from cesar.whisperx_wrapper import WhisperXPipeline, WhisperXSegment

Keep: OrchestrationResult dataclass, FormattingError exception, _save_plain_transcript method
  </action>
  <verify>
```bash
python -c "from cesar.orchestrator import TranscriptionOrchestrator, OrchestrationResult; print('Imports work')"
python -c "
from cesar.orchestrator import TranscriptionOrchestrator
import inspect
sig = inspect.signature(TranscriptionOrchestrator.__init__)
params = list(sig.parameters.keys())
print('Constructor params:', params)
assert 'pipeline' in params, 'Missing pipeline param'
assert 'transcriber' not in params, 'Should not have transcriber param'
assert 'diarizer' not in params, 'Should not have diarizer param'
print('Constructor signature correct')
"
```
  </verify>
  <done>Orchestrator uses WhisperXPipeline, no longer imports timestamp_aligner or SpeakerDiarizer</done>
</task>

<task type="auto">
  <name>Task 3: Delete timestamp_aligner.py and fix dependent imports</name>
  <files>cesar/timestamp_aligner.py, cesar/transcriber.py, cesar/transcript_formatter.py</files>
  <action>
1. DELETE cesar/timestamp_aligner.py entirely

2. Fix cesar/transcriber.py:
   - Remove: `from cesar.timestamp_aligner import TranscriptionSegment`
   - Add TranscriptionSegment dataclass directly in transcriber.py (same definition):
     ```python
     @dataclass
     class TranscriptionSegment:
         """Segment from Whisper transcription."""
         start: float
         end: float
         text: str
     ```
   - Keep using it in transcribe_to_segments() return type

3. Fix cesar/transcript_formatter.py:
   - Remove: `from cesar.timestamp_aligner import AlignedSegment, format_timestamp`
   - Move format_timestamp function into transcript_formatter.py (same implementation)
   - Update type hint: Change `List[AlignedSegment]` to just `List` or use duck typing
   - The formatter already works with any object having start/end/speaker/text attributes
   - Can add a comment: "Accepts any segment with start, end, speaker, text attributes (WhisperXSegment, etc.)"
  </action>
  <verify>
```bash
# Verify timestamp_aligner.py is deleted
test ! -f cesar/timestamp_aligner.py && echo "timestamp_aligner.py deleted"

# Verify transcriber still works
python -c "from cesar.transcriber import AudioTranscriber, TranscriptionSegment; print('Transcriber OK')"

# Verify formatter still works
python -c "from cesar.transcript_formatter import MarkdownTranscriptFormatter, format_timestamp; print('Formatter OK')"

# Verify no dangling imports
python -c "import cesar.orchestrator; import cesar.transcriber; import cesar.transcript_formatter; print('All modules import cleanly')"
```
  </verify>
  <done>timestamp_aligner.py deleted, TranscriptionSegment moved to transcriber.py, format_timestamp moved to transcript_formatter.py</done>
</task>

</tasks>

<verification>
```bash
# All core modules import without errors
python -c "
import cesar.orchestrator
import cesar.diarization
import cesar.transcriber
import cesar.transcript_formatter
import cesar.whisperx_wrapper
print('All core modules import OK')
"

# Exception classes still available
python -c "
from cesar.diarization import DiarizationError, AuthenticationError
raise DiarizationError('test')
" 2>&1 | grep -q "DiarizationError: test" && echo "Exceptions work"

# timestamp_aligner.py no longer exists
test ! -f cesar/timestamp_aligner.py && echo "timestamp_aligner.py successfully deleted"

# orchestrator uses WhisperXPipeline
grep -q "WhisperXPipeline" cesar/orchestrator.py && echo "Orchestrator uses WhisperXPipeline"
grep -qv "SpeakerDiarizer" cesar/orchestrator.py && echo "Orchestrator no longer uses SpeakerDiarizer"
```
</verification>

<success_criteria>
- timestamp_aligner.py deleted from codebase
- orchestrator.py constructor accepts pipeline (WhisperXPipeline) instead of transcriber/diarizer
- DiarizationError and AuthenticationError remain importable from cesar.diarization
- All cesar.* modules import without errors
- No references to deleted timestamp_aligner module remain
</success_criteria>

<output>
After completion, create `.planning/phases/15-orchestrator-simplification/15-01-SUMMARY.md`
</output>
