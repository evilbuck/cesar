---
phase: 15-orchestrator-simplification
plan: 03
type: execute
wave: 3
depends_on: ["15-01", "15-02"]
files_modified:
  - tests/test_orchestrator.py
  - tests/test_diarization.py
  - tests/test_timestamp_aligner.py
  - tests/test_transcript_formatter.py
autonomous: true

must_haves:
  truths:
    - "All unit tests pass after migration"
    - "test_timestamp_aligner.py is deleted (module no longer exists)"
    - "test_orchestrator.py tests new WhisperXPipeline-based orchestrator"
    - "test_diarization.py only tests exception classes (no SpeakerDiarizer tests)"
  artifacts:
    - path: "tests/test_orchestrator.py"
      provides: "Updated orchestrator tests for WhisperXPipeline"
      contains: "WhisperXPipeline"
    - path: "tests/test_diarization.py"
      provides: "Exception class tests only"
      min_lines: 20
  key_links:
    - from: "tests/test_orchestrator.py"
      to: "cesar/whisperx_wrapper.py"
      via: "WhisperXPipeline import"
      pattern: "from cesar.whisperx_wrapper import WhisperXPipeline"
---

<objective>
Update unit tests for new WhisperXPipeline-based architecture

Purpose: Ensure all tests pass with the simplified orchestrator. Delete obsolete test_timestamp_aligner.py, update test_orchestrator.py to mock WhisperXPipeline, and slim down test_diarization.py.

Output: Passing test suite with updated mocks and deleted obsolete tests
</objective>

<execution_context>
@/home/buckleyrobinson/.claude/get-shit-done/workflows/execute-plan.md
@/home/buckleyrobinson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-orchestrator-simplification/15-01-SUMMARY.md
@.planning/phases/15-orchestrator-simplification/15-02-SUMMARY.md
@tests/test_orchestrator.py
@tests/test_diarization.py
@tests/test_timestamp_aligner.py
@tests/test_transcript_formatter.py
@cesar/orchestrator.py
@cesar/whisperx_wrapper.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete test_timestamp_aligner.py</name>
  <files>tests/test_timestamp_aligner.py</files>
  <action>
DELETE tests/test_timestamp_aligner.py entirely.

The module it tested (timestamp_aligner.py) no longer exists. All alignment is now handled internally by WhisperX.
  </action>
  <verify>
```bash
test ! -f tests/test_timestamp_aligner.py && echo "test_timestamp_aligner.py deleted"
```
  </verify>
  <done>test_timestamp_aligner.py deleted</done>
</task>

<task type="auto">
  <name>Task 2: Update test_diarization.py for exception classes only</name>
  <files>tests/test_diarization.py</files>
  <action>
Rewrite test_diarization.py to only test the remaining exception classes.

1. Remove all TestSpeakerDiarizer tests (the class no longer exists)

2. Keep/add tests for:
   - DiarizationError is an exception
   - AuthenticationError is a subclass of DiarizationError
   - Both can be raised and caught
   - SpeakerSegment dataclass (if kept in module)
   - DiarizationResult dataclass (if kept in module)

3. Remove imports for SpeakerDiarizer

Example minimal test file:
```python
"""Tests for diarization exception classes."""
import unittest

from cesar.diarization import (
    DiarizationError,
    AuthenticationError,
)


class TestDiarizationExceptions(unittest.TestCase):
    """Tests for diarization exception classes."""

    def test_diarization_error_is_exception(self):
        """Test DiarizationError is an exception."""
        with self.assertRaises(DiarizationError):
            raise DiarizationError("test error")

    def test_authentication_error_is_diarization_error(self):
        """Test AuthenticationError is a subclass of DiarizationError."""
        self.assertTrue(issubclass(AuthenticationError, DiarizationError))

    def test_authentication_error_can_be_caught_as_diarization_error(self):
        """Test AuthenticationError can be caught as DiarizationError."""
        with self.assertRaises(DiarizationError):
            raise AuthenticationError("auth failed")

    def test_exception_message_preserved(self):
        """Test exception message is preserved."""
        try:
            raise DiarizationError("specific message")
        except DiarizationError as e:
            self.assertEqual(str(e), "specific message")


if __name__ == '__main__':
    unittest.main()
```
  </action>
  <verify>
```bash
python -m pytest tests/test_diarization.py -v
```
  </verify>
  <done>test_diarization.py only tests exception classes, all tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Update test_orchestrator.py for WhisperXPipeline</name>
  <files>tests/test_orchestrator.py</files>
  <action>
Rewrite test_orchestrator.py to test the new WhisperXPipeline-based orchestrator.

Import changes:
- Remove: SpeakerDiarizer, DiarizationResult, SpeakerSegment from cesar.diarization
- Remove: TranscriptionSegment, AlignedSegment from cesar.timestamp_aligner
- Remove: AudioTranscriber from cesar.transcriber
- Add: WhisperXPipeline, WhisperXSegment from cesar.whisperx_wrapper
- Keep: DiarizationError from cesar.diarization

Mock changes:
- Mock WhisperXPipeline instead of AudioTranscriber + SpeakerDiarizer
- Mock pipeline.transcribe_and_diarize() to return (segments, speaker_count, duration)
- Segments are WhisperXSegment objects (not TranscriptionSegment + AlignedSegment)

Test case updates:
1. test_orchestrate_success_with_diarization:
   - Create mock pipeline returning WhisperXSegments
   - Verify orchestrator calls pipeline.transcribe_and_diarize()
   - Verify result has diarization_succeeded=True

2. test_orchestrate_diarization_disabled:
   - Orchestrator with no pipeline
   - Currently raises NotImplementedError (expected - transcription-only needs AudioTranscriber)
   - Can mark as expectedFailure or skip with note

3. test_orchestrate_diarization_fails_gracefully:
   - Mock pipeline.transcribe_and_diarize() to raise DiarizationError
   - Verify fallback behavior (currently NotImplementedError for fallback)
   - Can mark as expectedFailure or skip with note

4. test_orchestrate_transcription_fails_propagates:
   - Mock pipeline.transcribe_and_diarize() to raise Exception
   - Verify exception propagates

5. test_orchestrate_progress_callback:
   - Mock pipeline to accept progress_callback
   - Verify callback is passed through

6. Remove tests that don't apply:
   - test_orchestrate_calls_align_timestamps (no align_timestamps anymore)
   - test_orchestrate_creates_formatter_if_not_provided (still applies)
   - test_orchestrate_keep_intermediate_files (needs review)

7. TestOrchestrationResult tests remain unchanged (dataclass properties still same)

Note: Some tests may need @unittest.expectedFailure or @unittest.skip temporarily
because fallback transcription-only path is not yet implemented. Document this clearly.
  </action>
  <verify>
```bash
python -m pytest tests/test_orchestrator.py -v
```
  </verify>
  <done>test_orchestrator.py updated to mock WhisperXPipeline, tests pass</done>
</task>

</tasks>

<verification>
```bash
# All test files exist (except deleted ones)
test ! -f tests/test_timestamp_aligner.py && echo "timestamp_aligner tests deleted"
test -f tests/test_orchestrator.py && echo "orchestrator tests exist"
test -f tests/test_diarization.py && echo "diarization tests exist"

# Run the updated test files
python -m pytest tests/test_diarization.py tests/test_orchestrator.py tests/test_transcript_formatter.py -v

# Full test suite (may have some expected failures for unimplemented fallback)
python -m pytest tests/ -v --ignore=tests/test_cli.py --ignore=tests/test_server.py --ignore=tests/test_worker.py
```
</verification>

<success_criteria>
- test_timestamp_aligner.py deleted
- test_diarization.py passes (exception class tests only)
- test_orchestrator.py passes (with WhisperXPipeline mocks)
- test_transcript_formatter.py passes (unchanged or minor import fixes)
- No import errors from deleted modules
</success_criteria>

<output>
After completion, create `.planning/phases/15-orchestrator-simplification/15-03-SUMMARY.md`
</output>
