---
phase: 08-error-handling-docs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cesar/youtube_handler.py
  - tests/test_youtube_handler.py
autonomous: true

must_haves:
  truths:
    - "Invalid YouTube URLs return clear error message with video ID"
    - "Private videos return distinct error message"
    - "Age-restricted videos return distinct error message"
    - "Network timeouts return error message suggesting retry"
    - "Rate limiting returns error message explaining YouTube throttling"
  artifacts:
    - path: "cesar/youtube_handler.py"
      provides: "Enhanced exception hierarchy and error detection"
      exports: ["YouTubeAgeRestrictedError", "YouTubeNetworkError", "extract_video_id"]
    - path: "tests/test_youtube_handler.py"
      provides: "Unit tests for new error types and detection patterns"
  key_links:
    - from: "cesar/youtube_handler.py"
      to: "yt_dlp.utils.DownloadError"
      via: "exception string matching in download_youtube_audio"
      pattern: "error_str.*in.*error_str"
---

<objective>
Enhance YouTube error handling with granular error types and user-friendly messages

Purpose: Provide clear, actionable error messages for all YouTube-related failures so users understand what went wrong and what they can do about it.

Output: Extended exception hierarchy with new error types (age-restricted, network), video ID extraction for error messages, and enhanced error detection patterns in download_youtube_audio.
</objective>

<execution_context>
@/home/buckleyrobinson/.claude/get-shit-done/workflows/execute-plan.md
@/home/buckleyrobinson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-error-handling-docs/08-CONTEXT.md
@.planning/phases/08-error-handling-docs/08-RESEARCH.md
@cesar/youtube_handler.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add new exception classes and video ID extraction</name>
  <files>cesar/youtube_handler.py</files>
  <action>
Extend the existing exception hierarchy in youtube_handler.py:

1. Add `error_type` and `http_status` class attributes to existing exceptions:
   - YouTubeDownloadError: error_type="youtube_error", http_status=400
   - YouTubeURLError: error_type="invalid_youtube_url", http_status=400
   - YouTubeUnavailableError: error_type="video_unavailable", http_status=404
   - YouTubeRateLimitError: error_type="rate_limited", http_status=429
   - FFmpegNotFoundError: error_type="ffmpeg_not_found", http_status=503

2. Add new exception classes (as subclasses to preserve hierarchy):
   - YouTubeAgeRestrictedError(YouTubeUnavailableError): error_type="age_restricted", http_status=403
   - YouTubeNetworkError(YouTubeDownloadError): error_type="network_error", http_status=502

3. Add extract_video_id(url: str) -> str function:
   - Extract 11-character video ID from YouTube URL patterns
   - Patterns: v=, youtu.be/, shorts/, embed/, v/
   - Return "unknown" if extraction fails

Error message style follows CONTEXT.md decisions:
- Brief technical info + plain English explanation
- Include video ID (not full URL)
- Retry suggestions only for network errors
  </action>
  <verify>python -c "from cesar.youtube_handler import YouTubeAgeRestrictedError, YouTubeNetworkError, extract_video_id; print('Imports OK'); print(extract_video_id('https://youtube.com/watch?v=dQw4w9WgXcQ'))"</verify>
  <done>New exception classes have error_type/http_status attributes; extract_video_id returns video ID from URLs</done>
</task>

<task type="auto">
  <name>Task 2: Enhance error detection in download_youtube_audio</name>
  <files>cesar/youtube_handler.py</files>
  <action>
Enhance the exception handling in download_youtube_audio() to detect and categorize more error types:

Update the DownloadError exception handler to detect (in order, most specific first):

1. Age-restricted videos:
   - Pattern: 'sign in to confirm your age' in error_str
   - Raise: YouTubeAgeRestrictedError with message:
     "Age-restricted video (video: {video_id}). This video requires sign-in to verify age."

2. Private videos (make message more specific):
   - Pattern: 'private video' in error_str
   - Raise: YouTubeUnavailableError with message:
     "Private video (video: {video_id}). This video is private and cannot be accessed."

3. Geo-restricted videos:
   - Pattern: 'not available in your country' in error_str or 'geo' in error_str
   - Raise: YouTubeUnavailableError with message:
     "Geo-restricted video (video: {video_id}). This video is not available in your region."

4. Network timeout:
   - Pattern: 'timed out' in error_str or 'timeout' in error_str
   - Raise: YouTubeNetworkError with message:
     "Network timeout (video: {video_id}). Connection timed out. Check your network and try again."

5. Connection reset:
   - Pattern: 'connection reset' in error_str or 'errno 104' in error_str
   - Raise: YouTubeNetworkError with message:
     "Connection interrupted (video: {video_id}). The connection was reset. Try again."

6. General network error:
   - Pattern: any of ['network', 'connection', 'urlopen'] in error_str
   - Raise: YouTubeNetworkError with message:
     "Network error (video: {video_id}). Could not connect to YouTube. Check your network and try again."

7. Rate limiting (already exists, update message):
   - Pattern: '403' or 'forbidden' or '429' in error_str
   - Raise: YouTubeRateLimitError with message:
     "YouTube is limiting requests (video: {video_id}). This is YouTube throttling connections. Try again later."

8. General unavailable (already exists, update message):
   - Pattern: 'unavailable' in error_str
   - Raise: YouTubeUnavailableError with message:
     "Video unavailable (video: {video_id}). This video may have been deleted or made private."

Also update YouTubeURLError message in the early validation:
- "Invalid YouTube URL (video: {video_id}). The URL format is not recognized."

Use extract_video_id(url) to get video ID for all error messages.
  </action>
  <verify>python -c "from cesar.youtube_handler import download_youtube_audio, YouTubeNetworkError; print('Enhanced error detection ready')"</verify>
  <done>download_youtube_audio raises specific exception types with user-friendly messages including video ID</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for new error types and patterns</name>
  <files>tests/test_youtube_handler.py</files>
  <action>
Add comprehensive unit tests for the enhanced error handling:

1. TestExtractVideoId class:
   - test_extract_from_watch_url: 'https://youtube.com/watch?v=dQw4w9WgXcQ' -> 'dQw4w9WgXcQ'
   - test_extract_from_youtu_be: 'https://youtu.be/dQw4w9WgXcQ' -> 'dQw4w9WgXcQ'
   - test_extract_from_shorts: 'https://youtube.com/shorts/abc123XYZ00' -> 'abc123XYZ00'
   - test_extract_from_embed: 'https://youtube.com/embed/dQw4w9WgXcQ' -> 'dQw4w9WgXcQ'
   - test_extract_with_extra_params: 'https://youtube.com/watch?v=dQw4w9WgXcQ&list=PLxyz' -> 'dQw4w9WgXcQ'
   - test_extract_from_invalid_url: 'https://example.com/video' -> 'unknown'

2. TestExceptionAttributes class:
   - test_youtube_download_error_attributes: verify error_type='youtube_error', http_status=400
   - test_youtube_url_error_attributes: verify error_type='invalid_youtube_url', http_status=400
   - test_youtube_unavailable_error_attributes: verify error_type='video_unavailable', http_status=404
   - test_youtube_rate_limit_error_attributes: verify error_type='rate_limited', http_status=429
   - test_youtube_age_restricted_error_attributes: verify error_type='age_restricted', http_status=403
   - test_youtube_network_error_attributes: verify error_type='network_error', http_status=502
   - test_ffmpeg_not_found_error_attributes: verify error_type='ffmpeg_not_found', http_status=503

3. TestDownloadErrorDetection class (mock yt-dlp DownloadError):
   - test_detects_age_restricted: mock DownloadError with 'sign in to confirm your age' -> YouTubeAgeRestrictedError
   - test_detects_private_video: mock DownloadError with 'private video' -> YouTubeUnavailableError with 'Private' in message
   - test_detects_geo_restricted: mock DownloadError with 'not available in your country' -> YouTubeUnavailableError with 'Geo-restricted' in message
   - test_detects_network_timeout: mock DownloadError with 'timed out' -> YouTubeNetworkError
   - test_detects_connection_reset: mock DownloadError with 'connection reset' -> YouTubeNetworkError
   - test_detects_rate_limit_403: mock DownloadError with '403' -> YouTubeRateLimitError
   - test_error_message_includes_video_id: verify video ID appears in error messages

Add imports for new exception classes: YouTubeAgeRestrictedError, YouTubeNetworkError, extract_video_id

Run: python -m pytest tests/test_youtube_handler.py -v
  </action>
  <verify>python -m pytest tests/test_youtube_handler.py -v --tb=short</verify>
  <done>All new tests pass, covering exception attributes, video ID extraction, and error detection patterns</done>
</task>

</tasks>

<verification>
1. All existing tests still pass: python -m pytest tests/ -v --tb=short
2. New exception classes have error_type and http_status attributes
3. Error messages include video ID instead of full URL
4. Network errors suggest retry, other errors do not
</verification>

<success_criteria>
- [ ] YouTubeAgeRestrictedError and YouTubeNetworkError classes exist with correct attributes
- [ ] extract_video_id function returns video ID from various YouTube URL formats
- [ ] download_youtube_audio raises specific exceptions for age-restricted, private, geo-restricted, network, rate-limited errors
- [ ] All error messages follow "Brief technical (video: {id}). Plain explanation." format
- [ ] All 180+ project tests pass
- [ ] New tests cover exception attributes, video ID extraction, and error detection
</success_criteria>

<output>
After completion, create `.planning/phases/08-error-handling-docs/08-01-SUMMARY.md`
</output>
