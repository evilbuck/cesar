---
phase: 07-interface-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cesar/cli.py
  - tests/test_cli.py
autonomous: true

must_haves:
  truths:
    - "User can run cesar transcribe <youtube-url> -o output.txt and get transcript"
    - "CLI displays download progress during YouTube audio extraction"
    - "Quiet mode suppresses download progress"
    - "Invalid YouTube URLs show clear error message"
  artifacts:
    - path: "cesar/cli.py"
      provides: "CLI transcribe command accepting YouTube URLs"
      contains: "is_youtube_url|download_youtube_audio"
    - path: "tests/test_cli.py"
      provides: "Tests for YouTube URL handling in CLI"
      contains: "youtube"
  key_links:
    - from: "cesar/cli.py"
      to: "cesar/youtube_handler.py"
      via: "import and function call"
      pattern: "from cesar.youtube_handler import|download_youtube_audio"
---

<objective>
Add YouTube URL support to the CLI transcribe command

Purpose: Enable users to transcribe YouTube videos directly via `cesar transcribe <youtube-url> -o output.txt`
Output: CLI accepts URLs (YouTube or file paths), downloads YouTube audio with progress display, then transcribes
</objective>

<execution_context>
@/home/buckleyrobinson/.claude/get-shit-done/workflows/execute-plan.md
@/home/buckleyrobinson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-core-youtube-module/06-01-SUMMARY.md
@cesar/cli.py
@cesar/youtube_handler.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify CLI to accept URLs or file paths</name>
  <files>cesar/cli.py</files>
  <action>
Modify the `transcribe` command to accept both file paths and URLs:

1. Change `input_file` argument from `click.Path(exists=True)` to `click.STRING` type
   - Rename parameter to `input_source` for clarity
   - Update metavar to `INPUT` and help text to indicate both file/URL accepted

2. Add import at top:
   ```python
   from cesar.youtube_handler import (
       is_youtube_url,
       download_youtube_audio,
       cleanup_youtube_temp_dir,
       YouTubeDownloadError,
       FFmpegNotFoundError,
   )
   ```

3. Create a new `DownloadProgressTracker` class for YouTube download progress:
   - Similar to existing `ProgressTracker` but for download phase
   - Description shows "Downloading YouTube audio..."
   - Use indeterminate progress (spinner) since yt-dlp progress is difficult to capture

4. In the `transcribe` function, after validation but before transcription:
   - Check if `input_source` is a URL using simple heuristic (starts with http:// or https://)
   - If URL, check if YouTube URL using `is_youtube_url(input_source)`
   - If YouTube URL:
     - Create temp file using `download_youtube_audio(input_source)`
     - Store path for cleanup after transcription
     - Set flag to delete temp file after completion
   - If regular URL, raise error (not supported in CLI - use API instead)
   - If not URL, validate file exists using `Path(input_source).exists()`

5. Add cleanup logic:
   - After transcription completes (or fails), delete downloaded temp file if it exists
   - Use try/finally to ensure cleanup even on error

6. Add YouTube-specific error handling in the exception handlers:
   ```python
   except FFmpegNotFoundError as e:
       console.print(f"[red]Error: {e}[/red]")
       click.echo(str(e), err=True)
       return 1
   except YouTubeDownloadError as e:
       console.print(f"[red]YouTube Error: {e}[/red]")
       click.echo(f"YouTube Error: {e}", err=True)
       return 1
   ```

7. Update the docstring to mention YouTube URL support

Do NOT use yt-dlp's progress hooks - they're complex and the download is usually fast. Use a simple spinner instead.
  </action>
  <verify>
Manual verification:
- `cesar transcribe --help` shows INPUT accepts file or YouTube URL
- Code has correct imports from youtube_handler
- Exception handlers include FFmpegNotFoundError and YouTubeDownloadError
  </verify>
  <done>
CLI transcribe command accepts YouTube URLs and downloads audio before transcription
  </done>
</task>

<task type="auto">
  <name>Task 2: Add download progress display</name>
  <files>cesar/cli.py</files>
  <action>
Implement progress display for YouTube downloads:

1. Create a context manager for download phase display:
   ```python
   @contextmanager
   def download_progress(quiet: bool):
       """Show download progress spinner unless quiet mode."""
       if quiet:
           yield
           return

       with Progress(
           SpinnerColumn(),
           TextColumn("[progress.description]{task.description}"),
           TimeElapsedColumn(),
           console=console,
           transient=True,
       ) as progress:
           progress.add_task("Downloading YouTube audio...", total=None)
           yield
   ```

2. In the transcribe command, wrap the download call:
   ```python
   if is_youtube_url(input_source):
       if not quiet:
           console.print(f"[blue]Detected YouTube URL[/blue]")

       with download_progress(quiet):
           audio_path = download_youtube_audio(input_source)

       temp_audio_path = audio_path  # Mark for cleanup
       if not quiet:
           console.print(f"[green]Downloaded audio:[/green] {audio_path.name}")
   ```

3. The existing ProgressTracker handles transcription progress - no changes needed there

4. Ensure two distinct phases are visible to user:
   - "Downloading YouTube audio..." (spinner)
   - "Transcribing audio..." (progress bar) - existing behavior
  </action>
  <verify>
Manual verification of code structure:
- download_progress context manager exists
- Two distinct progress phases in code flow
- Quiet mode check wraps progress display
  </verify>
  <done>
CLI shows spinner during YouTube download, then progress bar during transcription
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for CLI YouTube support</name>
  <files>tests/test_cli.py</files>
  <action>
Add tests for YouTube URL handling in CLI:

1. Import required mocks:
   ```python
   from unittest.mock import patch, MagicMock
   from pathlib import Path
   ```

2. Add test for YouTube URL detection and download:
   ```python
   @patch('cesar.cli.download_youtube_audio')
   @patch('cesar.cli.is_youtube_url')
   def test_transcribe_youtube_url(self, mock_is_youtube, mock_download):
       """Test transcribing a YouTube URL."""
       mock_is_youtube.return_value = True
       # Create a real temp file for the mock to return
       with tempfile.NamedTemporaryFile(suffix='.m4a', delete=False) as f:
           f.write(b'fake audio')
           temp_path = Path(f.name)
       mock_download.return_value = temp_path

       # Also mock the transcriber to avoid real transcription
       with patch('cesar.cli.AudioTranscriber') as mock_transcriber:
           mock_instance = MagicMock()
           mock_instance.get_audio_duration.return_value = 60.0
           mock_instance.transcribe_file.return_value = {
               'language': 'en',
               'language_probability': 0.99,
               'audio_duration': 60.0,
               'processing_time': 5.0,
               'speed_ratio': 12.0,
               'segment_count': 10,
               'output_path': '/tmp/output.txt',
           }
           mock_transcriber.return_value = mock_instance

           runner = CliRunner()
           result = runner.invoke(cli, [
               'transcribe',
               'https://www.youtube.com/watch?v=test123',
               '-o', '/tmp/output.txt',
               '-q',  # Quiet to simplify output checking
           ])

       # Verify download was called
       mock_download.assert_called_once()
       # Cleanup
       if temp_path.exists():
           temp_path.unlink()
   ```

3. Add test for FFmpeg not found error:
   ```python
   @patch('cesar.cli.is_youtube_url')
   @patch('cesar.cli.download_youtube_audio')
   def test_transcribe_youtube_ffmpeg_missing(self, mock_download, mock_is_youtube):
       """Test YouTube URL with FFmpeg missing."""
       from cesar.youtube_handler import FFmpegNotFoundError
       mock_is_youtube.return_value = True
       mock_download.side_effect = FFmpegNotFoundError("FFmpeg not found")

       runner = CliRunner()
       result = runner.invoke(cli, [
           'transcribe',
           'https://www.youtube.com/watch?v=test123',
           '-o', '/tmp/output.txt',
       ])

       assert result.exit_code != 0
       assert 'FFmpeg' in result.output or 'FFmpeg' in (result.stderr or '')
   ```

4. Add test for YouTube download error:
   ```python
   @patch('cesar.cli.is_youtube_url')
   @patch('cesar.cli.download_youtube_audio')
   def test_transcribe_youtube_download_error(self, mock_download, mock_is_youtube):
       """Test YouTube URL with download error."""
       from cesar.youtube_handler import YouTubeUnavailableError
       mock_is_youtube.return_value = True
       mock_download.side_effect = YouTubeUnavailableError("Video unavailable")

       runner = CliRunner()
       result = runner.invoke(cli, [
           'transcribe',
           'https://www.youtube.com/watch?v=test123',
           '-o', '/tmp/output.txt',
       ])

       assert result.exit_code != 0
   ```

5. Add test for non-YouTube URL rejection:
   ```python
   def test_transcribe_non_youtube_url_rejected(self):
       """Test that non-YouTube URLs are rejected in CLI."""
       runner = CliRunner()
       result = runner.invoke(cli, [
           'transcribe',
           'https://example.com/audio.mp3',
           '-o', '/tmp/output.txt',
       ])

       # Should fail - CLI only supports files and YouTube URLs
       assert result.exit_code != 0
   ```
  </action>
  <verify>
Run: `python -m pytest tests/test_cli.py -v -k youtube`
All YouTube-related tests pass
  </verify>
  <done>
Unit tests cover YouTube URL detection, download progress, FFmpeg errors, and download failures
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run `python -m pytest tests/test_cli.py -v` - all tests pass
2. Run `python -m pytest tests/` - all project tests pass
3. Manual test: `cesar transcribe --help` shows URL support in help text
</verification>

<success_criteria>
- CLI accepts YouTube URLs as input source
- Download progress shown during YouTube audio extraction (unless quiet mode)
- Temp audio file cleaned up after transcription
- YouTube-specific errors handled with clear messages
- All unit tests pass including new YouTube tests
</success_criteria>

<output>
After completion, create `.planning/phases/07-interface-integration/07-01-SUMMARY.md`
</output>
