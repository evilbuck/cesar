---
phase: 13-api-integration
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - cesar/api/worker.py
  - tests/test_worker.py
autonomous: true

must_haves:
  truths:
    - "Worker uses orchestrator when diarization enabled"
    - "Worker updates job progress during processing"
    - "Worker handles HF token from config"
    - "Worker sets PARTIAL status on diarization failure"
    - "Worker correctly handles retry of partial jobs"
  artifacts:
    - path: "cesar/api/worker.py"
      provides: "Orchestrator integration with progress callbacks"
      contains: "TranscriptionOrchestrator"
    - path: "tests/test_worker.py"
      provides: "Worker diarization tests"
      contains: "diarize"
  key_links:
    - from: "cesar/api/worker.py"
      to: "cesar/orchestrator.py"
      via: "TranscriptionOrchestrator import and usage"
      pattern: "orchestrator\\.orchestrate"
    - from: "cesar/api/worker.py"
      to: "cesar/api/models.py"
      via: "JobStatus.PARTIAL for fallback"
      pattern: "JobStatus\\.PARTIAL"
    - from: "cesar/api/worker.py"
      to: "cesar/diarization.py"
      via: "AuthenticationError for hf_token_invalid detection"
      pattern: "AuthenticationError"
---

<objective>
Integrate TranscriptionOrchestrator into the background worker to enable diarization for API jobs with progress tracking and graceful fallback.

Purpose: Worker executes diarization pipeline when requested, reports progress, handles failures gracefully
Output: Worker uses orchestrator, updates progress, handles partial failures
</objective>

<execution_context>
@/home/buckleyrobinson/.claude/get-shit-done/workflows/execute-plan.md
@/home/buckleyrobinson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/13-api-integration/13-CONTEXT.md
@.planning/phases/13-api-integration/13-RESEARCH.md
@.planning/phases/13-api-integration/13-01-SUMMARY.md
@cesar/api/worker.py
@cesar/api/models.py
@cesar/orchestrator.py
@cesar/diarization.py
@cesar/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate orchestrator into worker</name>
  <files>cesar/api/worker.py</files>
  <action>
Refactor _process_job and _run_transcription to use TranscriptionOrchestrator:

1. Add imports at top:
   - from cesar.orchestrator import TranscriptionOrchestrator, OrchestrationResult
   - from cesar.diarization import SpeakerDiarizer, DiarizationError, AuthenticationError
   - from cesar.config import CesarConfig

2. Add _get_hf_token method to BackgroundWorker:
   - Accept optional CesarConfig in __init__ (store as self.config, default to None)
   - Check self.config.hf_token first if config provided
   - Fall back to HF_TOKEN env var
   - Fall back to ~/.cache/huggingface/token
   - Return token or None

3. Update __init__ to accept optional config parameter:
   - def __init__(self, repository, poll_interval=1.0, config=None)
   - Store config for HF token resolution (self.config = config)
   - Handle config=None gracefully (Plan 03 may not always pass config)

4. Modify _run_transcription to use orchestrator:
   - Rename to _run_transcription_with_orchestrator
   - Accept additional params: diarize, min_speakers, max_speakers
   - Create AudioTranscriber as before
   - If diarize=True and HF token available:
     - Create SpeakerDiarizer with hf_token
     - Create TranscriptionOrchestrator with both
   - If diarize=True but no HF token:
     - Return early with diarization_error_code="hf_token_required"
   - Call orchestrator.orchestrate() with all params
   - Return OrchestrationResult plus text content

5. Update _process_job to:
   - Pass job.diarize, job.min_speakers, job.max_speakers to transcription
   - Update job.speaker_count from result.speakers_detected
   - Update job.diarized from result.diarization_succeeded
   - Handle partial failure: if diarize=True but diarization_succeeded=False
     - Set job.status = JobStatus.PARTIAL
     - Set job.diarization_error with explanation
   - Handle HF token missing:
     - Set job.status = JobStatus.PARTIAL
     - Set job.diarization_error_code = "hf_token_required"

6. Add explicit AuthenticationError handling for hf_token_invalid:
   - Wrap orchestrator.orchestrate() in try/except
   - Catch AuthenticationError specifically (from cesar.diarization)
   - When AuthenticationError caught:
     - Set job.status = JobStatus.PARTIAL
     - Set job.diarization_error_code = "hf_token_invalid"
     - Set job.diarization_error = str(e) or descriptive message
     - Still save transcription result if available
   - Catch generic DiarizationError for other diarization failures:
     - Set job.status = JobStatus.PARTIAL
     - Set job.diarization_error_code = "diarization_failed"
     - Set job.diarization_error = str(e)

7. Handle retry case in _process_job:
   - Check if job has result_text but diarization_error (retry scenario)
   - If retry: skip transcription, only run diarization on existing audio
   - This enables POST /jobs/{id}/retry to work

Note: Progress updates are complex due to sync callback from async context.
For Phase 13, update progress at phase boundaries only (not real-time).
  </action>
  <verify>python -c "from cesar.api.worker import BackgroundWorker; bw = BackgroundWorker(None, config=None); print(f'config attr exists: {hasattr(bw, \"config\")}, _get_hf_token exists: {hasattr(bw, \"_get_hf_token\")}')"</verify>
  <done>Worker uses orchestrator when diarize=True, handles HF token, catches AuthenticationError for hf_token_invalid, sets PARTIAL on failures</done>
</task>

<task type="auto">
  <name>Task 2: Add progress tracking to worker</name>
  <files>cesar/api/worker.py</files>
  <action>
Add phase-based progress tracking to _process_job:

1. Define progress phases and allocations (matching orchestrator):
   - "downloading": 0% start (YouTube only)
   - "transcribing": 0-60%
   - "diarizing": 60-90%
   - "formatting": 90-100%

2. Create helper method _update_progress(job, phase, overall_pct, phase_pct):
   - Set job.progress = int(overall_pct)
   - Set job.progress_phase = phase
   - Set job.progress_phase_pct = int(phase_pct)
   - Note: Actual DB update happens at status transitions

3. Update _process_job to call _update_progress at phase boundaries:
   - After download complete: _update_progress(job, "transcribing", 0, 0)
   - Before orchestrate: progress updated internally by orchestrator
   - After orchestrate: _update_progress(job, "formatting", 100, 100)

4. For real-time progress (optional enhancement):
   - The orchestrator accepts progress_callback
   - Callback runs in thread pool (sync context)
   - For now, only update at phase boundaries
   - Full real-time would need queue-based approach (deferred)

5. Ensure progress fields are included in repository.update calls.
  </action>
  <verify>python -c "from cesar.api.worker import BackgroundWorker; bw = BackgroundWorker(None); print(f'_update_progress exists: {hasattr(bw, \"_update_progress\")}')"</verify>
  <done>Worker tracks progress phases and updates job progress at phase boundaries</done>
</task>

<task type="auto">
  <name>Task 3: Add worker diarization tests</name>
  <files>tests/test_worker.py</files>
  <action>
Add tests for worker diarization functionality:

1. Test diarization disabled (diarize=False):
   - Create job with diarize=False
   - Mock transcriber to return simple result
   - Verify job.diarized=False, job.speaker_count=None
   - Verify job.status=COMPLETED

2. Test diarization enabled without HF token:
   - Create job with diarize=True
   - Worker has no config, no env var, no cached token
   - Mock token resolution to return None
   - Verify job.status=PARTIAL
   - Verify job.diarization_error_code="hf_token_required"
   - Verify job.result_text still contains transcript

3. Test diarization enabled with mock success:
   - Create job with diarize=True, min_speakers=2
   - Mock SpeakerDiarizer and TranscriptionOrchestrator
   - Mock orchestrate() to return OrchestrationResult with diarization_succeeded=True
   - Verify job.status=COMPLETED
   - Verify job.speaker_count > 0
   - Verify job.diarized=True

4. Test diarization fallback (orchestrator returns diarization_succeeded=False):
   - Create job with diarize=True
   - Mock orchestrate() to return diarization_succeeded=False
   - Verify job.status=PARTIAL
   - Verify job.diarized=False
   - Verify job.diarization_error is set

5. Test AuthenticationError handling (hf_token_invalid):
   - Create job with diarize=True
   - Mock SpeakerDiarizer to raise AuthenticationError
   - Verify job.status=PARTIAL
   - Verify job.diarization_error_code="hf_token_invalid"
   - Verify transcription still saved if available

6. Test retry job detection:
   - Create job with result_text set and diarization_error set (simulating partial)
   - Process job
   - Verify transcription is skipped (check mock call count)
   - Verify diarization is attempted

Use existing test patterns from the file (async tests, mocking, in-memory DB).
  </action>
  <verify>cd /home/buckleyrobinson/projects/cesar && python -m pytest tests/test_worker.py -v -k "diarize" --tb=short</verify>
  <done>Worker tests cover diarization enabled/disabled, HF token missing, AuthenticationError, fallback, retry</done>
</task>

</tasks>

<verification>
1. Run worker tests:
   python -m pytest tests/test_worker.py -v --tb=short

2. Verify imports work:
   python -c "from cesar.api.worker import BackgroundWorker; from cesar.orchestrator import TranscriptionOrchestrator; print('Integration OK')"

3. Run full test suite to check for regressions:
   python -m pytest tests/ -v --tb=short --ignore=tests/test_youtube_handler.py
</verification>

<success_criteria>
- Worker imports and uses TranscriptionOrchestrator
- Worker resolves HF token from config/env/cache
- Worker catches AuthenticationError and sets diarization_error_code="hf_token_invalid"
- Job gets PARTIAL status when diarization fails but transcription succeeds
- Job progress fields are updated during processing
- All worker tests pass including new diarization tests
</success_criteria>

<output>
After completion, create `.planning/phases/13-api-integration/13-02-SUMMARY.md`
</output>
