---
phase: 06-core-youtube-module
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cesar/youtube_handler.py
  - tests/test_youtube_handler.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "is_youtube_url() returns True for valid YouTube URLs (watch, shorts, youtu.be)"
    - "is_youtube_url() returns False for non-YouTube URLs"
    - "check_ffmpeg_available() returns (True, '') when ffmpeg and ffprobe exist"
    - "check_ffmpeg_available() returns (False, error_msg) when ffmpeg missing"
    - "download_youtube_audio() returns path to downloaded .m4a file"
    - "download_youtube_audio() raises FFmpegNotFoundError if ffmpeg missing"
    - "download_youtube_audio() raises YouTubeURLError for invalid URLs"
    - "Partial files cleaned up on download failure"

  artifacts:
    - path: "cesar/youtube_handler.py"
      provides: "YouTube download module with URL validation and FFmpeg check"
      exports: ["is_youtube_url", "check_ffmpeg_available", "require_ffmpeg", "download_youtube_audio", "cleanup_youtube_temp_dir"]
      min_lines: 100
    - path: "tests/test_youtube_handler.py"
      provides: "Unit tests for youtube_handler module"
      min_lines: 80

  key_links:
    - from: "cesar/youtube_handler.py"
      to: "yt_dlp"
      via: "import yt_dlp, YoutubeDL context manager"
      pattern: "yt_dlp\\.YoutubeDL"
    - from: "cesar/youtube_handler.py"
      to: "shutil.which"
      via: "FFmpeg binary detection"
      pattern: "shutil\\.which\\('ffmpeg'\\)"
---

<objective>
Create the youtube_handler.py module that provides YouTube audio extraction via yt-dlp.

Purpose: This is the core shared service that CLI (Phase 7) and API (Phase 7) will call to download audio from YouTube URLs before transcription.

Output:
- `cesar/youtube_handler.py` with is_youtube_url(), check_ffmpeg_available(), download_youtube_audio()
- Unit tests covering all public functions
- yt-dlp dependency added to pyproject.toml
</objective>

<execution_context>
@/home/buckleyrobinson/.claude/get-shit-done/workflows/execute-plan.md
@/home/buckleyrobinson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-core-youtube-module/06-RESEARCH.md
@cesar/api/worker.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create youtube_handler.py module</name>
  <files>cesar/youtube_handler.py, pyproject.toml</files>
  <action>
Create `cesar/youtube_handler.py` following the complete module example in 06-RESEARCH.md:

1. **Exception classes** (at top of module):
   - `YouTubeDownloadError` - base exception
   - `YouTubeURLError` - invalid URL
   - `YouTubeUnavailableError` - private/deleted/geo-blocked
   - `YouTubeRateLimitError` - 403/429 errors
   - `FFmpegNotFoundError` - FFmpeg binary not found

2. **FFmpeg validation** (SYS-01, SYS-02):
   - `check_ffmpeg_available() -> tuple[bool, str]` with `@lru_cache(maxsize=1)`
   - Check both `ffmpeg` and `ffprobe` via `shutil.which()`
   - Return helpful install instructions in error message (pacman, apt, brew)
   - `require_ffmpeg()` that raises `FFmpegNotFoundError` if missing

3. **URL validation** (part of YT-01):
   - `YOUTUBE_URL_PATTERNS` list with regex for watch, shorts, youtu.be, embed, v/ URLs
   - Compile to `_YOUTUBE_REGEX` at module level
   - `is_youtube_url(url: str) -> bool` - simple prefix matching

4. **Download function** (YT-02, YT-03, YT-04):
   - `download_youtube_audio(url: str, output_dir: Optional[Path] = None) -> Path`
   - Call `require_ffmpeg()` first
   - Validate URL with `is_youtube_url()`
   - Create temp dir at `{tempdir}/cesar-youtube/`
   - Use UUID-based filename to avoid collisions
   - ydl_opts with format='bestaudio/best', FFmpegExtractAudio postprocessor, m4a codec
   - CRITICAL: Use dict outtmpl format: `'outtmpl': {'default': output_template}`
   - Wrap yt_dlp.YoutubeDL in context manager
   - Catch DownloadError, ExtractorError, PostProcessingError and map to custom exceptions
   - Clean up partial files on ANY exception via `_cleanup_partial_files()` helper
   - Find actual output file (yt-dlp adds extension)

5. **Cleanup utilities**:
   - `_cleanup_partial_files(directory: Path, base_name: str) -> None` - remove .part, .ytdl files
   - `cleanup_youtube_temp_dir() -> int` - optional startup cleanup, returns count

6. **Add yt-dlp dependency to pyproject.toml**:
   - Add `"yt-dlp>=2024.1.0"` to dependencies array
   - Note: Use 2024 not 2026 since the version in research may be future-dated

Module should be ~120-150 lines with comprehensive docstrings.
  </action>
  <verify>
```bash
# Module imports without error
python -c "from cesar.youtube_handler import is_youtube_url, check_ffmpeg_available, download_youtube_audio"

# Check exports exist
python -c "from cesar import youtube_handler; print([x for x in dir(youtube_handler) if not x.startswith('_')])"
```
  </verify>
  <done>
- youtube_handler.py exists with all 5 exception classes
- is_youtube_url() exported and callable
- check_ffmpeg_available() exported and callable
- download_youtube_audio() exported and callable
- cleanup_youtube_temp_dir() exported and callable
- yt-dlp in pyproject.toml dependencies
  </done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for youtube_handler</name>
  <files>tests/test_youtube_handler.py</files>
  <action>
Create `tests/test_youtube_handler.py` with comprehensive unit tests:

1. **TestIsYouTubeUrl class**:
   - test_valid_watch_url: `https://www.youtube.com/watch?v=dQw4w9WgXcQ`
   - test_valid_watch_url_no_www: `https://youtube.com/watch?v=dQw4w9WgXcQ`
   - test_valid_youtu_be: `https://youtu.be/dQw4w9WgXcQ`
   - test_valid_shorts: `https://www.youtube.com/shorts/abc123`
   - test_valid_embed: `https://www.youtube.com/embed/abc123`
   - test_invalid_vimeo: `https://vimeo.com/123456` returns False
   - test_invalid_random_url: `https://example.com/video` returns False
   - test_empty_url: `''` returns False
   - test_none_url: `None` returns False

2. **TestCheckFfmpegAvailable class**:
   - test_ffmpeg_available: Mock `shutil.which` to return paths, assert (True, '')
   - test_ffmpeg_missing: Mock `shutil.which` to return None, assert (False, error_msg)
   - test_ffprobe_missing: Mock ffmpeg found but ffprobe None
   - IMPORTANT: Call `check_ffmpeg_available.cache_clear()` before each test

3. **TestDownloadYouTubeAudio class** (mocked - no real downloads):
   - test_invalid_url_raises_error: Pass vimeo URL, expect YouTubeURLError
   - test_ffmpeg_missing_raises_error: Mock require_ffmpeg to raise, expect FFmpegNotFoundError
   - test_download_success: Mock YoutubeDL, mock Path.exists, assert returns Path
   - test_download_error_403_raises_rate_limit: Mock DownloadError with '403', expect YouTubeRateLimitError
   - test_download_error_unavailable: Mock DownloadError with 'unavailable', expect YouTubeUnavailableError
   - test_cleanup_called_on_failure: Mock download to fail, verify _cleanup_partial_files pattern called

4. **TestCleanupYouTubeTempDir class**:
   - test_cleanup_nonexistent_dir: Returns 0 when dir doesn't exist
   - test_cleanup_empty_dir: Returns 0 when dir empty
   - test_cleanup_with_files: Create temp files, verify cleanup removes them

Use `unittest` (project standard), `unittest.mock.patch` and `MagicMock`.
Follow existing test patterns in tests/ directory.
  </action>
  <verify>
```bash
# Run tests
python -m pytest tests/test_youtube_handler.py -v

# Verify test count (should be 15+ tests)
python -m pytest tests/test_youtube_handler.py --collect-only | grep "test_" | wc -l
```
  </verify>
  <done>
- tests/test_youtube_handler.py exists with 4 test classes
- All tests pass (15+ tests)
- URL validation tests cover all patterns
- FFmpeg validation tests use mocking
- Download tests use mocking (no real YouTube requests)
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify all existing tests still pass</name>
  <files></files>
  <action>
Run the full test suite to ensure the new module and dependency don't break existing functionality.

1. Install the updated package with new yt-dlp dependency:
   ```bash
   pip install -e .
   ```

2. Run all tests:
   ```bash
   python -m pytest tests/ -v
   ```

3. If any tests fail, investigate and fix. The new youtube_handler.py should not affect existing code.
  </action>
  <verify>
```bash
# Full test suite passes
python -m pytest tests/ -v --tb=short

# Verify yt-dlp installed
python -c "import yt_dlp; print(f'yt-dlp version: {yt_dlp.version.__version__}')"
```
  </verify>
  <done>
- All existing tests pass
- New youtube_handler tests pass
- yt-dlp successfully installed and importable
- No regressions in existing functionality
  </done>
</task>

</tasks>

<verification>
Phase 6 requirements verified:

- YT-01: `youtube_handler.py` provides `is_youtube_url()` and `download_youtube_audio()`
- YT-02: yt-dlp extracts best quality audio to temp file (via download_youtube_audio)
- YT-03: Temp files cleaned up after transcription (cleanup_youtube_temp_dir available for caller)
- YT-04: Temp files cleaned up on failure (try/finally with _cleanup_partial_files)
- SYS-01: FFmpeg validated via check_ffmpeg_available() with lru_cache
- SYS-02: YouTube jobs rejected with clear error via require_ffmpeg() -> FFmpegNotFoundError

```bash
# Verify requirements
python -c "
from cesar.youtube_handler import (
    is_youtube_url,
    download_youtube_audio,
    check_ffmpeg_available,
    require_ffmpeg,
    FFmpegNotFoundError,
    YouTubeURLError,
)
print('YT-01: is_youtube_url exists:', callable(is_youtube_url))
print('YT-01: download_youtube_audio exists:', callable(download_youtube_audio))
print('SYS-01: check_ffmpeg_available exists:', callable(check_ffmpeg_available))
print('SYS-02: require_ffmpeg exists:', callable(require_ffmpeg))
print('SYS-02: FFmpegNotFoundError exists:', FFmpegNotFoundError is not None)
"
```
</verification>

<success_criteria>
1. `cesar/youtube_handler.py` exists with all public functions
2. `tests/test_youtube_handler.py` exists with 15+ passing tests
3. `pyproject.toml` includes yt-dlp dependency
4. All existing tests continue to pass
5. `python -c "from cesar.youtube_handler import download_youtube_audio"` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/06-core-youtube-module/06-01-SUMMARY.md`
</output>
