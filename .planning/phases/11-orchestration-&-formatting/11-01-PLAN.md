---
phase: 11-orchestration-formatting
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - cesar/transcript_formatter.py
  - tests/test_transcript_formatter.py
autonomous: true

must_haves:
  truths:
    - "Aligned segments are formatted into Markdown with speaker headers"
    - "Timestamps appear in [MM:SS.d - MM:SS.d] format below each speaker header"
    - "Metadata header shows speakers detected, duration, and creation date"
    - "Segments below minimum duration threshold are filtered out"
    - "Multiple speakers overlap shows as 'Multiple speakers' header"
  artifacts:
    - path: "cesar/transcript_formatter.py"
      provides: "MarkdownTranscriptFormatter class"
      exports: ["MarkdownTranscriptFormatter"]
    - path: "tests/test_transcript_formatter.py"
      provides: "Unit tests for formatter"
      min_lines: 100
  key_links:
    - from: "cesar/transcript_formatter.py"
      to: "cesar/timestamp_aligner.py"
      via: "imports format_timestamp, AlignedSegment"
      pattern: "from cesar\\.timestamp_aligner import"
---

<objective>
Create TDD-tested Markdown transcript formatter for speaker-labeled output.

Purpose: Format aligned segments into clean Markdown with speaker headers, timestamps, and metadata - the exact output format users will see for diarized transcripts.

Output:
- cesar/transcript_formatter.py with MarkdownTranscriptFormatter class
- tests/test_transcript_formatter.py with comprehensive test coverage
</objective>

<execution_context>
@/home/buckleyrobinson/.claude/get-shit-done/workflows/execute-plan.md
@/home/buckleyrobinson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-orchestration-&-formatting/11-CONTEXT.md
@.planning/phases/11-orchestration-&-formatting/11-RESEARCH.md
@cesar/timestamp_aligner.py
</context>

<feature>
  <name>Markdown Transcript Formatter</name>
  <files>cesar/transcript_formatter.py, tests/test_transcript_formatter.py</files>
  <behavior>
    Format aligned segments into Markdown with speaker labels and timestamps.

    Input: List of AlignedSegment, speaker_count, audio_duration, min_segment_duration
    Output: Markdown string with header and speaker sections

    Cases:
    - format_with_speakers([seg1, seg2], 2, 120.5) -> "# Transcript\n\n**Speakers:** 2 detected\n..."
    - format_with_speakers([seg], 1, 60.0) -> Includes single speaker section
    - format_with_speakers([], 0, 0.0) -> Raises FormattingError
    - Segment with duration < min_segment_duration -> Filtered out
    - Segment with speaker="Multiple speakers" -> Gets "### Multiple speakers" header
    - Consecutive same-speaker segments -> New timestamp line, no extra header
    - Duration > 1 hour -> Format as HH:MM:SS
  </behavior>
  <implementation>
    1. Create MarkdownTranscriptFormatter class with:
       - __init__(min_segment_duration: float = 1.0)
       - format_with_speakers(aligned_segments, speaker_count, audio_duration) -> str
       - _build_header(speaker_count, audio_duration) -> list[str]
       - _format_duration(seconds) -> str (MM:SS or HH:MM:SS)
       - _should_include(segment) -> bool (based on min_segment_duration)
       - _get_speaker_label(segment) -> str (handles "Multiple speakers" case)

    2. Follow exact format from CONTEXT.md:
       ```markdown
       # Transcript

       **Speakers:** {N} detected
       **Duration:** {MM:SS}
       **Created:** {YYYY-MM-DD}

       ---

       ### {Speaker label}
       [{timestamp}]
       {text}
       ```

    3. Create FormattingError exception for error cases

    4. Import format_timestamp from timestamp_aligner.py (already implements [MM:SS.d] format)
  </implementation>
</feature>

<tasks>

<task type="auto">
  <name>Task 1: Write failing tests for transcript formatter</name>
  <files>tests/test_transcript_formatter.py</files>
  <action>
Create comprehensive unit tests BEFORE implementation. Tests should fail initially.

Test cases to cover:
1. test_format_basic_two_speakers - Two segments, different speakers, correct Markdown output
2. test_format_metadata_header - Verify speakers count, duration, date in header
3. test_format_duration_under_hour - Duration formats as MM:SS
4. test_format_duration_over_hour - Duration formats as HH:MM:SS
5. test_format_timestamp_format - Timestamps use [MM:SS.d - MM:SS.d] format
6. test_format_multiple_speakers_label - "Multiple speakers" gets correct header
7. test_format_consecutive_same_speaker - Same speaker shows new timestamp, no repeated header
8. test_filter_short_segments - Segments below threshold are excluded
9. test_filter_custom_threshold - Custom min_segment_duration works
10. test_empty_segments_raises_error - Empty input raises FormattingError
11. test_all_filtered_raises_error - All segments below threshold raises FormattingError
12. test_single_speaker_format - Single speaker formatting works correctly
13. test_speaker_order_preserved - Segments appear in input order

Use AlignedSegment from timestamp_aligner.py for test data.
Mock datetime.now() for consistent created date in tests.

Run tests to confirm they fail (RED phase).
  </action>
  <verify>python -m pytest tests/test_transcript_formatter.py -v --tb=short shows all tests FAILING (expected - implementation not written yet)</verify>
  <done>13+ failing tests covering all formatting scenarios exist in tests/test_transcript_formatter.py</done>
</task>

<task type="auto">
  <name>Task 2: Implement formatter to pass tests</name>
  <files>cesar/transcript_formatter.py</files>
  <action>
Implement MarkdownTranscriptFormatter class to make all tests pass (GREEN phase).

Implementation details:
1. Create FormattingError exception class

2. Create MarkdownTranscriptFormatter class:
   - __init__(self, min_segment_duration: float = 1.0)
   - Store threshold for filtering

3. format_with_speakers method:
   - Filter segments by duration threshold
   - If no segments remain after filtering, raise FormattingError
   - Build header with _build_header()
   - Iterate segments, tracking current_speaker
   - When speaker changes: add "### {speaker}" header
   - For each segment: add timestamp line + text
   - Join with newlines and return

4. _build_header method:
   - "# Transcript" title
   - Empty line
   - "**Speakers:** {N} detected"
   - "**Duration:** {formatted}"
   - "**Created:** {YYYY-MM-DD}"
   - Empty line
   - "---"
   - Empty line

5. _format_duration method:
   - If seconds >= 3600: return HH:MM:SS
   - Else: return MM:SS

6. _should_include method:
   - Return (segment.end - segment.start) >= self.min_segment_duration

7. _get_speaker_label method:
   - If segment.speaker == "Multiple speakers": return "Multiple speakers"
   - Else: return segment.speaker (SPEAKER_00 etc.)

Import format_timestamp from timestamp_aligner.py for timestamp formatting.

Run tests until all pass.
  </action>
  <verify>python -m pytest tests/test_transcript_formatter.py -v shows all tests PASSING</verify>
  <done>MarkdownTranscriptFormatter produces correct Markdown output, all 13+ tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite and commit</name>
  <files>cesar/transcript_formatter.py, tests/test_transcript_formatter.py</files>
  <action>
Verify integration with existing modules and commit.

1. Run full test suite: python -m pytest tests/ -v
   - All existing tests should still pass
   - New formatter tests should pass

2. Test import from package: python -c "from cesar.transcript_formatter import MarkdownTranscriptFormatter, FormattingError"

3. Quick integration smoke test:
   ```python
   from cesar.timestamp_aligner import AlignedSegment
   from cesar.transcript_formatter import MarkdownTranscriptFormatter

   segments = [
       AlignedSegment(0.0, 10.5, "SPEAKER_00", "Hello world"),
       AlignedSegment(10.5, 20.0, "SPEAKER_01", "Hi there")
   ]
   formatter = MarkdownTranscriptFormatter()
   output = formatter.format_with_speakers(segments, 2, 20.0)
   print(output)
   ```

4. Commit with descriptive message following TDD pattern.
  </action>
  <verify>python -m pytest tests/ -v shows all tests passing (existing + new)</verify>
  <done>Full test suite passes, formatter module committed</done>
</task>

</tasks>

<verification>
1. Import works: `from cesar.transcript_formatter import MarkdownTranscriptFormatter, FormattingError`
2. All tests pass: `python -m pytest tests/test_transcript_formatter.py -v`
3. Full suite passes: `python -m pytest tests/ -v`
4. Output matches CONTEXT.md format specification
</verification>

<success_criteria>
- MarkdownTranscriptFormatter class exists with format_with_speakers() method
- FormattingError exception exists for error cases
- All 13+ test cases pass
- Output format matches CONTEXT.md specification exactly:
  - # Transcript header with metadata
  - ### Speaker headers with timestamps below
  - [MM:SS.d - MM:SS.d] timestamp format
  - Segments filtered by minimum duration
- Full test suite remains green
</success_criteria>

<output>
After completion, create `.planning/phases/11-orchestration-&-formatting/11-01-SUMMARY.md`
</output>
