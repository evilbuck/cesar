# Milestone v2.0: API

**Status:** âœ… SHIPPED 2026-01-23
**Phases:** 2-5
**Total Plans:** 7

## Overview

This milestone adds an HTTP API layer to Cesar, enabling programmatic transcription access via async job queue. Starting from the existing CLI (v1.0), we build foundation data models, a background worker for sequential job processing, HTTP endpoints with FastAPI, and CLI integration. The result is `cesar serve` launching a server with full OpenAPI docs.

## Phases

### Phase 2: Foundation

**Goal**: Job data can be persisted and retrieved from SQLite
**Depends on**: Phase 1 (v1.0 CLI - complete)
**Plans**: 2 plans

Plans:

- [x] 02-01-PLAN.md - Job model and JobStatus enum with Pydantic v2
- [x] 02-02-PLAN.md - SQLite schema and JobRepository with async CRUD

**Details:**

- Job Pydantic model with all required fields (id, status, audio_path, model_size, timestamps, results, error)
- JobStatus enum with four states: queued, processing, completed, error
- Validation for model_size and audio_path
- SQLite schema with jobs table and indexes
- JobRepository with async CRUD operations (create, get, update, list_all, get_next_queued)
- WAL mode and optimized PRAGMAs for concurrent access
- File-based persistence verified across connection close/reopen

### Phase 3: Background Worker

**Goal**: Jobs are processed sequentially in the background
**Depends on**: Phase 2
**Plans**: 1 plan

Plans:

- [x] 03-01-PLAN.md - BackgroundWorker with async loop and thread pool transcription

**Details:**

- BackgroundWorker class with async run() loop polling for queued jobs
- Sequential FIFO job processing (oldest queued job first)
- Blocking transcription wrapped in asyncio.to_thread() to avoid blocking event loop
- Graceful shutdown via asyncio.Event with current job completion
- 9 comprehensive unit tests covering all worker behaviors

### Phase 4: HTTP API

**Goal**: Full REST API for transcription jobs with OpenAPI docs
**Depends on**: Phase 3
**Plans**: 3 plans

Plans:

- [x] 04-01-PLAN.md - FastAPI server setup with lifespan and health endpoint
- [x] 04-02-PLAN.md - Job retrieval endpoints (GET /jobs, GET /jobs/{id})
- [x] 04-03-PLAN.md - Transcribe endpoints with file upload and URL support

**Details:**

- FastAPI application with lifespan context manager
- Health endpoint returning worker status at GET /health
- OpenAPI documentation automatically available at /docs
- GET /jobs/{job_id} endpoint returns job details or 404
- GET /jobs endpoint returns all jobs with optional ?status= filter
- POST /transcribe endpoint accepting multipart file upload
- POST /transcribe/url endpoint accepting JSON with URL
- File validation (size limit 100MB, extension whitelist)
- URL download with 60-second timeout

### Phase 5: CLI Integration

**Goal**: Server can be started via cesar serve command
**Depends on**: Phase 4
**Plans**: 1 plan

Plans:

- [x] 05-01-PLAN.md - Add cesar serve command with uvicorn and job recovery

**Details:**

- cesar serve command with --port, --host, --reload, --workers flags
- Job recovery logic re-queues orphaned PROCESSING jobs on server startup
- Import string for uvicorn reload support
- 30-second graceful shutdown timeout
- Minimal startup message with listening URL

---

## Milestone Summary

**Key Decisions:**

- FastAPI for HTTP API (modern, async, automatic OpenAPI docs)
- SQLite for job persistence (no external dependencies, fits offline-first)
- Async job queue (transcription is slow, don't block requests)
- Pydantic v2 models (validation, serialization, ConfigDict pattern)
- WAL mode with busy_timeout (concurrent access, lock contention handling)
- Lifespan context manager (modern FastAPI pattern)
- Separate file/URL endpoints (different content types)
- Job recovery on startup (re-queue orphaned jobs from crashes)

**Issues Resolved:**

- TestClient context manager pattern for proper lifespan execution in tests
- Audio_path validation to prevent empty/whitespace paths

**Issues Deferred:**

- Webhook callbacks for job completion (v2.1)
- Model selection parameter for API (v2.1)
- Language specification parameter (v2.1)
- CLI refactor to use service layer (v3.0)

**Technical Debt Incurred:**

None - all phases delivered clean implementations.

---

_For current project status, see .planning/PROJECT.md_
