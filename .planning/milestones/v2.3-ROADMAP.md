# Milestone v2.3: WhisperX Migration

**Status:** âœ… SHIPPED 2026-02-02
**Phases:** 14-16
**Total Plans:** 9

## Overview

Replace pyannote diarization with WhisperX unified pipeline for better alignment and simpler architecture.

## Phases

### Phase 14: WhisperX Foundation

**Goal**: Install WhisperX and create wrapper module for unified pipeline
**Depends on**: Nothing (fresh foundation replacing pyannote)
**Requirements**: WX-01, WX-02, WX-05
**Success Criteria** (what must be TRUE):
  1. whisperx package installs successfully with compatible torch versions
  2. WhisperX model loads and transcribes audio files
  3. wav2vec2 alignment produces word-level timestamps
  4. Diarization pipeline assigns speakers to words
  5. Unit tests verify each pipeline stage in isolation
**Plans**: 3 plans in 3 waves

Plans:
- [x] 14-01: Update dependencies (remove pyannote.audio, add whisperx)
- [x] 14-02: Create WhisperXPipeline wrapper module
- [x] 14-03: Unit tests for WhisperXPipeline

**Details:**
- Replaced pyannote.audio>=3.1.0 with whisperx>=3.7.6
- Created WhisperXPipeline class (356 lines) with lazy model loading
- 43 unit tests covering all wrapper functionality
- Fixed torch/torchvision version compatibility (2.8.0/0.23.0)

### Phase 15: Orchestrator Simplification

**Goal**: Replace existing pipeline with WhisperX unified approach
**Depends on**: Phase 14 (WhisperX wrapper must exist)
**Requirements**: WX-03, WX-04, WX-08, WX-09
**Success Criteria** (what must be TRUE):
  1. timestamp_aligner.py is deleted from codebase
  2. orchestrator.py uses WhisperX pipeline instead of separate components
  3. Markdown output format matches existing format (speaker labels, timestamps)
  4. DiarizationError and AuthenticationError exceptions work unchanged
  5. Fallback to plain transcription works when diarization fails
**Plans**: 3 plans in 3 waves

Plans:
- [x] 15-01: Core module updates (orchestrator, diarization, delete timestamp_aligner)
- [x] 15-02: CLI and API worker integration with WhisperXPipeline
- [x] 15-03: Test updates for new architecture

**Details:**
- Deleted timestamp_aligner.py (254 lines removed)
- Simplified orchestrator to use WhisperXPipeline with AudioTranscriber fallback
- Updated CLI and worker to create WhisperXPipeline when diarize=True
- Migrated 42 tests to use WhisperXSegment instead of AlignedSegment

### Phase 16: Interface Verification

**Goal**: Validate all CLI and API interfaces work unchanged with new backend
**Depends on**: Phase 15 (orchestrator must be updated first)
**Requirements**: WX-06, WX-07, WX-10, WX-11, WX-12
**Success Criteria** (what must be TRUE):
  1. CLI --diarize flag produces speaker-labeled output (no interface changes)
  2. API diarize parameter produces speaker-labeled response (no interface changes)
  3. All existing diarization unit tests pass (with updated mocks)
  4. E2E CLI test: `cesar transcribe --diarize <file>` produces correct Markdown
  5. E2E API test: POST /transcribe with diarize=true produces correct response
**Plans**: 3 plans in 2 waves

Plans:
- [x] 16-01: E2E CLI diarization tests
- [x] 16-02: E2E API diarization tests
- [x] 16-03: Full test suite verification

**Details:**
- Added TestDiarizationE2E (5 tests) for CLI interface preservation
- Added TestTranscribeEndpointDiarizationE2E (6 tests) for API interface preservation
- Verified 108 diarization-related tests pass
- Verified 380/386 full suite tests pass (6 pre-existing failures)

---

## Milestone Summary

**Decimal Phases:**
- None (no urgent insertions during v2.3)

**Key Decisions:**
- WhisperX replaces direct pyannote.audio dependency (bundles transitively)
- Keep faster-whisper for backward compat during WhisperX migration
- WhisperXSegment compatible with AlignedSegment for formatter reuse
- Lazy model loading in WhisperXPipeline (defers to first use)
- Extensive whisperx mocking for fast CI (no model downloads needed)
- Formatter uses duck typing (List[Any]) for WhisperXSegment compatibility
- TranscriptionSegment moved to transcriber.py (co-located with producer)
- format_timestamp moved to transcript_formatter.py (co-located with consumer)
- CLI passes model size to WhisperXPipeline constructor
- Worker falls back to plain transcription on AuthenticationError (not hard failure)
- Orchestrator-level mocking for E2E tests (avoids torch import conflicts)
- Console quiet state reset in setUp/tearDown for test isolation

**Issues Resolved:**
- torch/torchvision version mismatch (installed compatible 2.8.0/0.23.0)
- Test isolation for Rich console state between tests
- Module import conflicts with whisperx mocking

**Issues Deferred:**
- 6 pre-existing test failures (TestYouTubeErrorFormatting, TestCLIConfigLoading) - Rich console mock issues

**Technical Debt Incurred:**
- 6 pre-existing test failures remain (unrelated to WhisperX migration)

---

_For current project status, see .planning/PROJECT.md_
